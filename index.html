<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>LPhone v2.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style id="global-theme-style"></style>
    <style>
        :root {
            /* 屏幕尺寸 */
            --phone-width: 380px;
            --phone-height: 820px;

            /* 颜色变量 */
            --wechat-bg: #EDEDED;
            --wechat-nav-bg: #F6F6F6;
            --wechat-border-color: #D8D8D8;
            --wechat-text-primary: #000000;
            --wechat-text-secondary: #888888;
            --wechat-green: #07C160;
            --wechat-blue: #576B95;
            --wechat-red: #FA5151;
            --special-orange-bg: #FCAE3D;

            /* 美化变量 */
            --user-avatar-frame: none;
            --char-avatar-frame: none;
            --avatar-shape: 6px;
            --chat-background-image: none;
            --home-screen-background-image: url('https://source.unsplash.com/random/380x820?gradient');
            --lock-screen-background-image: url('https://source.unsplash.com/random/380x820?night');
            --home-clock-color: #ffffff; /* 主屏/锁屏字体颜色 */
            --player-image: url('https://img.heliar.top/file/1764067235404_Screenshot_2025_1125_183413.png');
            --player-background: url('https://img.heliar.top/file/1764067231296_Screenshot_2025_1125_183056.png');
            --user-custom-font: 'UserCustomFont', -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
            --font-size-base: 15px;

            /* 手机边框 */
            --phone-border-color: #111;
            --phone-border-width: 10px;
            --phone-shadow: 0 15px 50px rgba(0,0,0,0.3);
            --phone-edge-highlight: transparent;
            --phone-backdrop-filter: none;

            /* 图标 */
            --app-icon-size: 60px;
            --app-icon-gap: 20px;
            --app-icon-radius: 15px;
        }

        /* --- 主题适配 --- */
        body.dark-mode { --wechat-bg: #121212; --wechat-nav-bg: #1E1E1E; --wechat-border-color: #3A3A3C; --wechat-text-primary: #EAEAEA; --wechat-text-secondary: #8E8E93; }
        body.dark-mode .list-item, body.dark-mode .me-profile-card, body.dark-mode .me-menu-item, body.dark-mode .chat-input-bar, body.dark-mode .modal-content, body.dark-mode .form-group input, body.dark-mode .form-group textarea, body.dark-mode .form-group select, body.dark-mode .moment-post, body.dark-mode .bank-card { background-color: var(--wechat-nav-bg); color: var(--wechat-text-primary); }
        body.dark-mode .message-row.received .message-bubble.text-bubble { background-color: var(--wechat-nav-bg); }
        body.dark-mode .message-row.received .message-bubble.text-bubble::after { background: var(--wechat-nav-bg); }
        body.dark-mode .message-recalled, body.dark-mode .message-system { background: #333; color: var(--wechat-text-secondary); }
        body.dark-mode .chat-input-bar input { background: #333; color: var(--wechat-text-primary); }
        body.dark-mode .chat-plus-menu { background: #252525; }
        body.dark-mode .plus-menu-item .icon { background: #333; border-color: #444; }
        body.dark-mode .header-back-btn, body.dark-mode .header-title, body.dark-mode .header-right { color: var(--wechat-text-primary); }
        body.dark-mode .tab-item { color: var(--wechat-text-secondary); }
        body.dark-mode .tab-item.active { color: var(--wechat-green); }

        /* 其他主题省略，逻辑同上，保持原有样式 */
        body.sakura-pink-mode { --wechat-bg: #FFF0F5; --wechat-nav-bg: #FFC0CB; --wechat-border-color: #FFB6C1; --wechat-text-primary: #333333; --wechat-text-secondary: #8B4513; --wechat-green: #FF69B4; --wechat-blue: #DB7093; }
        body.transparent-mode { --wechat-bg: transparent; --wechat-nav-bg: transparent; --wechat-border-color: rgba(255, 255, 255, 0.2); --wechat-text-primary: #FFFFFF; --wechat-text-secondary: #CCCCCC; }
        body.neumorphic-mode { --wechat-bg: #e0e5ec; --wechat-nav-bg: #e0e5ec; --wechat-border-color: transparent; --wechat-text-primary: #555; --wechat-text-secondary: #999; }
        body.clear-sky-blue-mode { --wechat-bg: #E1F5FE; --wechat-nav-bg: #B3E5FC; --wechat-border-color: #81D4FA; --wechat-text-primary: #01579B; --wechat-text-secondary: #4FC3F7; --wechat-green: #0288D1; --wechat-blue: #03A9F4; }
        body.dark-abyss-mode { --wechat-bg: transparent; --wechat-nav-bg: rgba(20, 20, 20, 0.75); --wechat-border-color: rgba(80, 80, 80, 0.5); --wechat-text-primary: #EAEAEA; --wechat-text-secondary: #A0A0A0; --wechat-green: #00E676; --wechat-blue: #64B5F6; }

        @font-face { font-family: 'UserCustomFont'; src: var(--user-custom-font-src); }
        @font-face { font-family: 'DiaryFont'; src: url('https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756988857890_qdqqd_enpyrq.ttf'); }

        body { display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #333; margin: 0; font-family: var(--user-custom-font); font-size: var(--font-size-base); overflow: hidden; }

        /* 手机外壳 */
        .phone-container { width: var(--phone-width); height: var(--phone-height); background: var(--phone-border-color); border-radius: 44px; box-shadow: var(--phone-shadow), 0 0 0 1px var(--phone-edge-highlight); display: flex; flex-direction: column; overflow: hidden; position: relative; border: var(--phone-border-width) solid var(--phone-border-color); transition: all 0.3s ease; backdrop-filter: var(--phone-backdrop-filter, none); }
        .screen { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; background-color: var(--wechat-bg); border-radius: 34px; overflow: hidden; }

        /* 状态栏 */
        .status-bar { height: 30px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; color: black; font-weight: 500; position: absolute; top: 0; left: 0; right: 0; z-index: 100; font-size: 12px; }
        body.dark-mode .status-bar, body.transparent-mode .status-bar, body.dark-abyss-mode .status-bar { color: white; }
        .status-bar-right { display: flex; align-items: center; gap: 6px; }
        .battery-icon { width: 22px; height: 10px; border: 1px solid currentColor; border-radius: 2.5px; position: relative; display: flex; align-items: center; padding: 1px; }
        .battery-icon::after { content: ''; width: 2px; height: 4px; background-color: currentColor; position: absolute; right: -4px; top: 50%; transform: translateY(-50%); border-radius: 0 1px 1px 0; }
        .battery-fill { height: 100%; background-color: currentColor; border-radius: 1px; width: 100%; }

        /* 页面通用 */
        .page { position: absolute; inset: 0; background-color: var(--wechat-bg); display: none; flex-direction: column; z-index: 10; transform: translateX(100%); transition: transform 0.3s ease-in-out; padding-top: 30px; }
        .page.active { display: flex; transform: translateX(0); }
        .page.no-transition { transition: none; }
        .page.sub-page { z-index: 20; }
        .wechat-header { height: 44px; background-color: var(--wechat-nav-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 10px; border-bottom: 0.5px solid var(--wechat-border-color); flex-shrink: 0; position: sticky; top: 0; z-index: 10; color: var(--wechat-text-primary); }
        .header-title { font-size: 17px; font-weight: 600; position: absolute; left: 50%; transform: translateX(-50%); }
        .header-left, .header-right { display: flex; align-items: center; gap: 15px; font-size: 22px; cursor: pointer; color: var(--wechat-text-primary); }
        .header-back-btn { font-size: 17px; color: var(--wechat-text-primary); display: flex; align-items: center; gap: 2px; }
        .content-area { flex: 1; overflow-y: auto; overflow-x: hidden; }
        .content-area::-webkit-scrollbar { width: 0px; }

        /* 锁屏页面 */
        #lock-screen-page { z-index: 9999; background-image: var(--lock-screen-background-image); background-size: cover; background-position: center; color: var(--home-clock-color); display: none; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 100px; transform: translateX(0); transition: transform 0.4s ease-in-out; }
        #lock-screen-page.active { display: flex; }
        #lock-screen-page.unlocking { transform: translateY(-100%); }
        .lock-time { font-size: 80px; font-weight: 200; line-height: 1; }
        .lock-date { font-size: 20px; margin-top: 10px; font-weight: 400; }
        .slide-to-unlock { position: absolute; bottom: 50px; width: 80%; height: 50px; background: rgba(255,255,255,0.2); border-radius: 25px; display: flex; align-items: center; padding: 0 5px; backdrop-filter: blur(5px); }
        .slide-text { position: absolute; width: 100%; text-align: center; color: rgba(255,255,255,0.8); font-size: 14px; pointer-events: none; animation: shimmer 2s infinite; }
        .slide-thumb { width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: #333; cursor: grab; position: relative; z-index: 2; }
        @keyframes shimmer { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }
        
        /* 密码输入界面 */
        #password-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .password-dots { display: flex; gap: 20px; margin-bottom: 50px; }
        .password-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; transition: background 0.2s; }
        .password-dot.filled { background: white; }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 280px; }
        .key-btn { width: 70px; height: 70px; border-radius: 50%; background: rgba(255,255,255,0.15); display: flex; justify-content: center; align-items: center; font-size: 28px; cursor: pointer; transition: background 0.2s; margin: 0 auto; }
        .key-btn:active { background: rgba(255,255,255,0.4); }

        /* 主屏幕 */
        #home-screen-page { background-image: var(--home-screen-background-image); background-size: cover; background-position: center; }
        .home-clock-widget { margin-top: 60px; text-align: center; color: var(--home-clock-color); margin-bottom: 20px; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .home-time { font-size: 60px; font-weight: 300; line-height: 1; }
        .home-date { font-size: 16px; margin-top: 5px; }
        .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--app-icon-gap); padding: 20px; width: 100%; box-sizing: border-box; }
        .app-icon { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; text-align: center; }
        .app-icon .icon-bg { width: var(--app-icon-size); height: var(--app-icon-size); border-radius: var(--app-icon-radius); background-size: cover; background-position: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .app-icon .app-name { font-size: 12px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

        /* 加载动画 */
        .loading-spinner { border: 3px solid rgba(0,0,0,0.1); border-left-color: var(--wechat-green); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 聊天气泡优化 */
        .message-bubble { position: relative; padding: 10px 14px; font-size: var(--font-size-base); line-height: 1.4; max-width: calc(var(--phone-width) - 120px); word-break: break-word; border-radius: 6px; user-select: none; color: var(--wechat-text-primary); }
        .message-row.sent .message-bubble.text-bubble { background: #96d35f; color: #000; }
        .message-row.received .message-bubble.text-bubble { background: #ffffff; color: #000; }
        /* 转发消息预览样式 */
        .forward-preview-item { padding: 4px 0; border-bottom: 1px solid #eee; font-size: 12px; color: #666; display: flex; align-items: center; gap: 5px; }
        .forward-preview-item:last-child { border-bottom: none; }
        .forward-preview-icon { width: 16px; text-align: center; }

        /* 其他样式保持原有基础，针对新功能微调 */
        .wechat-tabbar { display: flex; height: 50px; background-color: var(--wechat-nav-bg); border-top: 0.5px solid var(--wechat-border-color); flex-shrink: 0; }
        .tab-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 2px; color: var(--wechat-text-secondary); cursor: pointer; }
        .tab-item.active { color: var(--wechat-green); }
        
        /* 列表样式 */
        .list-item { display: flex; align-items: center; padding: 10px 15px; gap: 12px; border-bottom: 0.5px solid var(--wechat-border-color); cursor: pointer; background-color: var(--wechat-nav-bg); }
        .list-item:active { background-color: var(--wechat-bg); }
        .list-item .avatar { width: 48px; height: 48px; border-radius: var(--avatar-shape); object-fit: cover; }
        .list-item .details { flex: 1; overflow: hidden; }
        .list-item .details .name { font-size: var(--font-size-base); color: var(--wechat-text-primary); }
        .list-divider { height: 8px; background-color: var(--wechat-bg); }
        
        /* 开关 */
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--wechat-green); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* 模态框 */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--wechat-nav-bg); padding: 20px; border-radius: 12px; width: 85%; max-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color: var(--wechat-text-primary); max-height: 80vh; overflow-y: auto; }
        .modal-input { width: 100%; padding: 10px; border: 1px solid var(--wechat-border-color); border-radius: 6px; box-sizing: border-box; font-size: var(--font-size-base); background: var(--wechat-bg); color: var(--wechat-text-primary); margin-bottom: 10px; }
        .modal-btn { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--wechat-border-color); background: var(--wechat-bg); cursor: pointer; font-size: var(--font-size-base); color: var(--wechat-text-primary); margin-top: 5px; }
        .modal-btn.primary { background: var(--wechat-green); color: #fff; border-color: var(--wechat-green); }

        /* 聊天界面 */
        .message-row { display: flex; flex-direction: column; margin-bottom: 10px; max-width: 100%; }
        .message-body { display: flex; align-items: flex-start; gap: 10px; }
        .message-row.sent { align-items: flex-end; }
        .message-row.sent .message-body { flex-direction: row-reverse; }
        .message-avatar { width: 40px; height: 40px; border-radius: var(--avatar-shape); }
        .chat-input-bar { display: flex; align-items: center; padding: 8px 10px; gap: 10px; background: var(--wechat-nav-bg); border-top: 0.5px solid var(--wechat-border-color); }
        .chat-input-bar input { flex: 1; padding: 8px 12px; border: none; background: var(--wechat-bg); border-radius: 6px; font-size: var(--font-size-base); }
        
        /* 戳一戳气泡 */
        .poke-bubble { text-align: center; color: var(--wechat-text-secondary); font-size: 12px; margin: 5px 0; }
        .poke-bubble span { background: rgba(0,0,0,0.05); padding: 3px 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <!-- 激活弹窗 -->
    <div id="activation-modal" class="modal-overlay" style="display: flex; z-index: 20000;">
        <div class="modal-content" style="text-align: center;">
            <h3>激活 Lovely Phone</h3>
            <input type="text" id="activation-input" class="modal-input" placeholder="请输入激活码">
            <button class="modal-btn primary" id="activation-btn">激活</button>
        </div>
    </div>

    <div class="phone-container" id="phone-body" style="display: none;">
        <div class="screen">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div class="status-bar-left"><span class="time" id="status-bar-time">09:41</span></div>
                <div class="status-bar-right">
                    <span id="status-bar-network"><i class="fas fa-wifi"></i></span>
                    <div class="battery-icon"><div class="battery-fill" style="width: 100%;"></div></div>
                </div>
            </div>

            <!-- 锁屏页面 -->
            <div id="lock-screen-page">
                <div class="lock-time" id="lock-time">09:41</div>
                <div class="lock-date" id="lock-date">11月30日 星期日</div>
                <div class="slide-to-unlock" id="slide-track">
                    <div class="slide-text">向右滑动解锁</div>
                    <div class="slide-thumb" id="slide-thumb"><i class="fas fa-chevron-right"></i></div>
                </div>
            </div>

            <!-- 密码输入层 -->
            <div id="password-screen">
                <div style="margin-bottom: 20px; font-size: 18px;">输入密码</div>
                <div class="password-dots" id="password-dots">
                    <div class="password-dot"></div><div class="password-dot"></div><div class="password-dot"></div><div class="password-dot"></div>
                </div>
                <div class="keypad" id="keypad">
                    <!-- JS生成键盘 -->
                </div>
                <div style="margin-top: 30px; cursor: pointer;" onclick="cancelPassword()">取消</div>
            </div>

            <!-- 主屏幕 -->
            <div id="home-screen-page" class="page active no-transition">
                <div class="content-area">
                    <div class="home-clock-widget">
                        <div class="home-time" id="home-time">09:41</div>
                        <div class="home-date" id="home-date">11月30日 星期日</div>
                    </div>
                    <div class="app-grid" id="app-grid">
                        <!-- APP图标 -->
                    </div>
                </div>
            </div>

            <!-- WeChat App -->
            <div id="wechat-app-page" class="page sub-page">
                <div class="wechat-header" id="main-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i></div>
                    <span class="header-title">微信</span>
                    <div class="header-right"><i class="fas fa-plus-circle" id="main-plus-btn"></i></div>
                </div>
                <div class="content-area" id="main-content-area"></div>
                <div class="wechat-tabbar">
                    <div class="tab-item active" data-page="chat-list"><i class="fas fa-comment-dots"></i><span>聊天</span></div>
                    <div class="tab-item" data-page="contacts"><i class="fas fa-address-book"></i><span>通讯录</span></div>
                    <div class="tab-item" data-page="me"><i class="fas fa-user"></i><span>我</span></div>
                </div>
            </div>

            <!-- 其他页面容器 -->
            <div id="conversation-page" class="page sub-page"></div>
            <div id="settings-app-page" class="page sub-page"></div>
            <div id="beautify-page" class="page sub-page"></div>
            <div id="lock-settings-page" class="page sub-page form-page"></div>
            <div id="wallpaper-settings-page" class="page sub-page form-page"></div>
            <div id="poke-settings-page" class="page sub-page form-page"></div>
            
            <!-- 模态框容器 -->
            <div id="modal-container"></div>
        </div>
    </div>

    <!-- 音效 -->
    <audio id="send-sound-player"></audio>
    <audio id="receive-sound-player"></audio>
    <audio id="ringtone-player" loop></audio>

    <style id="user-bubble-style"></style>
    <style id="global-theme-style"></style>

    <script>
        // ========== 数据管理 ==========
        const defaultAppData = {
            user: { id: 'user', nickname: "我", avatar: "https://img.js.design/assets/img/6638e4537cf422dc287d398d.jpg", wallet: { balance: 1000, currency: 'CNY', transactions: [] } },
            contacts: [], groups: [], moments: [],
            settings: {
                lockScreen: { enabled: false, password: '', wallpaper: 'https://source.unsplash.com/random/380x820?night' },
                beautify: {
                    homeClockColor: '#ffffff',
                    homeScreenWallpaper: 'https://source.unsplash.com/random/380x820?gradient',
                    appIcons: { wechat: 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg', settings: 'https://img.js.design/assets/img/66547a8286955562f5597929.png' },
                    theme: 'normal'
                },
                poke: { userToChar: { action: '拍了拍', suffix: '' }, charToUser: { action: '拍了拍', suffix: '' } },
                api: { key: '', endpoint: '', model: '' }
            },
            activeChat: { id: null, type: null }
        };

        let appData = JSON.parse(localStorage.getItem('LPhoneData_v2')) || defaultAppData;

        function saveData() {
            localStorage.setItem('LPhoneData_v2', JSON.stringify(appData));
        }

        // ========== 核心逻辑 ==========
        
        // 导航
        let pageHistory = ['home-screen-page'];
        function showPage(pageId, renderFunc, ...args) {
            const page = document.getElementById(pageId);
            if (!page) return;
            pageHistory.push(pageId);
            if (renderFunc) renderFunc(page, ...args);
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            page.classList.add('active');
        }

        function goBack() {
            if (pageHistory.length <= 1) return;
            pageHistory.pop();
            const prevPageId = pageHistory[pageHistory.length - 1];
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(prevPageId).classList.add('active');
            if (prevPageId === 'wechat-app-page') {
                const activeTab = document.querySelector('.tab-item.active').dataset.page;
                renderMainContent(activeTab);
            }
        }

        // 锁屏逻辑
        let isLocked = true;
        let inputPassword = '';

        function initLockScreen() {
            const lockPage = document.getElementById('lock-screen-page');
            const thumb = document.getElementById('slide-thumb');
            const track = document.getElementById('slide-track');
            let startX, currentX;

            // 更新时间
            setInterval(() => {
                const now = new Date();
                const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                const dateStr = `${now.getMonth()+1}月${now.getDate()}日 星期${['日','一','二','三','四','五','六'][now.getDay()]}`;
                document.getElementById('lock-time').textContent = timeStr;
                document.getElementById('lock-date').textContent = dateStr;
                document.getElementById('home-time').textContent = timeStr;
                document.getElementById('home-date').textContent = dateStr;
                document.getElementById('status-bar-time').textContent = timeStr;
            }, 1000);

            // 滑动解锁
            thumb.addEventListener('mousedown', startDrag);
            thumb.addEventListener('touchstart', startDrag);

            function startDrag(e) {
                startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('touchmove', onDrag);
                document.addEventListener('mouseup', endDrag);
                document.addEventListener('touchend', endDrag);
            }

            function onDrag(e) {
                currentX = (e.type.includes('mouse') ? e.clientX : e.touches[0].clientX) - startX;
                const maxMove = track.offsetWidth - thumb.offsetWidth - 10;
                if (currentX < 0) currentX = 0;
                if (currentX > maxMove) currentX = maxMove;
                thumb.style.transform = `translateX(${currentX}px)`;
                thumb.style.transition = 'none';
            }

            function endDrag() {
                const maxMove = track.offsetWidth - thumb.offsetWidth - 10;
                if (currentX > maxMove * 0.8) {
                    // 解锁成功
                    if (appData.settings.lockScreen.enabled && appData.settings.lockScreen.password) {
                        showPasswordScreen();
                    } else {
                        unlockPhone();
                    }
                }
                thumb.style.transform = 'translateX(0)';
                thumb.style.transition = 'transform 0.3s';
                document.removeEventListener('mousemove', onDrag);
                document.removeEventListener('touchmove', onDrag);
            }
        }

        function showPasswordScreen() {
            const screen = document.getElementById('password-screen');
            screen.style.display = 'flex';
            inputPassword = '';
            updatePasswordDots();
            renderKeypad();
        }

        function renderKeypad() {
            const keypad = document.getElementById('keypad');
            keypad.innerHTML = [1,2,3,4,5,6,7,8,9,'',0,'<i class="fas fa-backspace"></i>'].map(k => 
                `<div class="key-btn" onclick="handleKey('${k}')">${k}</div>`
            ).join('');
        }

        function handleKey(k) {
            if (k === '') return;
            if (k.toString().includes('backspace')) {
                inputPassword = inputPassword.slice(0, -1);
            } else if (inputPassword.length < 4) {
                inputPassword += k;
            }
            updatePasswordDots();
            
            if (inputPassword.length === 4) {
                setTimeout(() => {
                    if (inputPassword === appData.settings.lockScreen.password) {
                        document.getElementById('password-screen').style.display = 'none';
                        unlockPhone();
                    } else {
                        alert('密码错误');
                        inputPassword = '';
                        updatePasswordDots();
                    }
                }, 200);
            }
        }

        function updatePasswordDots() {
            const dots = document.querySelectorAll('.password-dot');
            dots.forEach((d, i) => {
                if (i < inputPassword.length) d.classList.add('filled');
                else d.classList.remove('filled');
            });
        }

        function cancelPassword() {
            document.getElementById('password-screen').style.display = 'none';
            document.getElementById('slide-thumb').style.transform = 'translateX(0)';
        }

        function unlockPhone() {
            const lockPage = document.getElementById('lock-screen-page');
            lockPage.classList.add('unlocking');
            setTimeout(() => {
                lockPage.classList.remove('active', 'unlocking');
                isLocked = false;
            }, 400);
        }

        function lockPhone() {
            const lockPage = document.getElementById('lock-screen-page');
            lockPage.classList.remove('unlocking');
            lockPage.classList.add('active');
            isLocked = true;
            goBack(); // Return to home
            pageHistory = ['home-screen-page']; // Reset history
        }

        // ========== 页面渲染 ==========

        function renderHomeScreen(container) {
            const icons = appData.settings.beautify.appIcons;
            container.querySelector('#app-grid').innerHTML = `
                <div class="app-icon" onclick="showPage('wechat-app-page', renderWechatApp)">
                    <div class="icon-bg" style="background-image: url('${icons.wechat}')"></div><span class="app-name">WeChat</span>
                </div>
                <div class="app-icon" onclick="showPage('settings-app-page', renderSettingsAppPage)">
                    <div class="icon-bg" style="background-image: url('${icons.settings}')"></div><span class="app-name">设置</span>
                </div>
                <div class="app-icon" onclick="lockPhone()">
                    <div class="icon-bg" style="background: #333; display: flex; justify-content: center; align-items: center;"><i class="fas fa-lock" style="color: white; font-size: 24px;"></i></div><span class="app-name">锁屏</span>
                </div>
            `;
            applyBeautifySettings();
        }

        function renderWechatApp(container) {
            renderMainContent('chat-list');
        }

        function renderMainContent(tab) {
            const content = document.getElementById('main-content-area');
            const header = document.getElementById('main-header');
            content.innerHTML = '';
            if (tab === 'chat-list') {
                header.querySelector('.header-title').textContent = '微信';
                renderChatList(content);
            } else if (tab === 'contacts') {
                header.querySelector('.header-title').textContent = '通讯录';
                renderContacts(content);
            } else if (tab === 'me') {
                header.querySelector('.header-title').textContent = '';
                renderMe(content);
            }
        }

        // 聊天列表 (Mock)
        function renderChatList(container) {
            if (appData.contacts.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:50px; color:#999;">暂无聊天，去通讯录添加吧</div>';
                return;
            }
            container.innerHTML = appData.contacts.map(c => `
                <div class="list-item" onclick="showPage('conversation-page', renderConversation, '${c.id}')">
                    <img src="${c.avatar}" class="avatar">
                    <div class="details">
                        <span class="name">${c.name}</span>
                        <p class="subtext">${c.conversation.length > 0 ? '点击查看消息' : '暂无消息'}</p>
                    </div>
                </div>
            `).join('');
        }

        function renderContacts(container) {
            container.innerHTML = `<div class="list-item" onclick="addContact()"><i class="fas fa-plus-square" style="font-size: 40px; color: var(--wechat-green);"></i><span class="name">添加朋友</span></div>` + 
            appData.contacts.map(c => `
                <div class="list-item">
                    <img src="${c.avatar}" class="avatar">
                    <div class="details"><span class="name">${c.name}</span></div>
                </div>
            `).join('');
        }

        function addContact() {
            const name = prompt("输入新朋友名字");
            if(name) {
                appData.contacts.push({ id: Date.now(), name, avatar: 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg', conversation: [] });
                saveData();
                renderMainContent('contacts');
            }
        }

        function renderMe(container) {
            container.innerHTML = `
                <div class="me-profile-card">
                    <img src="${appData.user.avatar}" class="avatar">
                    <div class="details"><p class="name">${appData.user.nickname}</p><p class="wxid">微信号: wxid_user</p></div>
                </div>
                <div class="list-divider"></div>
                <div class="me-menu-item"><i class="fas fa-wallet" style="color: var(--wechat-green);"></i><span>服务</span></div>
            `;
        }

        // 聊天界面与转发优化
        function renderConversation(container, chatId) {
            appData.activeChat.id = chatId;
            const contact = appData.contacts.find(c => c.id == chatId);
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i></div>
                    <span class="header-title">${contact.name}</span>
                    <div class="header-right"><i class="fas fa-ellipsis-h"></i></div>
                </div>
                <div class="content-area" id="msg-area" style="padding: 10px; background-image: var(--chat-background-image); background-size: cover;"></div>
                <div class="chat-input-bar">
                    <input type="text" id="chat-input">
                    <i class="far fa-grin" onclick="triggerPoke('${chatId}')"></i>
                    <i class="fas fa-plus-circle" onclick="showChatMenu('${chatId}')"></i>
                </div>
            `;
            renderMessages(chatId);
            
            const input = document.getElementById('chat-input');
            input.onkeydown = (e) => {
                if(e.key === 'Enter' && input.value) {
                    sendMessage(chatId, 'text', { content: input.value });
                    input.value = '';
                }
            };
        }

        function renderMessages(chatId) {
            const contact = appData.contacts.find(c => c.id == chatId);
            const area = document.getElementById('msg-area');
            area.innerHTML = contact.conversation.map(msg => {
                if (msg.type === 'system') return `<div class="poke-bubble"><span>${msg.content.content}</span></div>`;
                const isMe = msg.sender === 'user';
                let contentHtml = '';
                
                // 消息渲染逻辑
                switch(msg.type) {
                    case 'text': contentHtml = msg.content.content; break;
                    case 'image': contentHtml = `<img src="${msg.content.url}" style="max-width: 150px; border-radius: 5px;">`; break;
                    case 'transfer': contentHtml = `<div style="background:#FCAE3D; color:white; padding:10px; border-radius:5px; display:flex; align-items:center; gap:10px;"><i class="fas fa-exchange-alt" style="font-size:24px;"></i><div><div>¥${msg.content.amount}</div><div style="font-size:12px;">${msg.content.remark}</div></div></div>`; break;
                    case 'redPacket': contentHtml = `<div style="background:#FA5151; color:white; padding:10px; border-radius:5px; display:flex; align-items:center; gap:10px;"><i class="fas fa-envelope" style="font-size:24px;"></i><div><div>${msg.content.remark}</div><div style="font-size:12px;">领取红包</div></div></div>`; break;
                    case 'forward': 
                        contentHtml = `<div style="background:white; padding:8px; border-radius:5px; width:200px;" onclick="showForwardDetail(${msg.id}, '${chatId}')">
                            <div style="font-size:14px; margin-bottom:5px;">[聊天记录]</div>
                            <div style="font-size:12px; color:#888;">
                                ${msg.content.preview.map(p => `<div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${p}</div>`).join('')}
                            </div>
                        </div>`;
                        break;
                    default: contentHtml = `[${msg.type}]`;
                }

                return `
                    <div class="message-row ${isMe ? 'sent' : 'received'}">
                        <div class="message-body">
                            <img src="${isMe ? appData.user.avatar : contact.avatar}" class="message-avatar">
                            <div class="message-bubble ${msg.type === 'text' ? 'text-bubble' : ''}" style="${msg.type !== 'text' ? 'background:transparent; padding:0;' : ''}">${contentHtml}</div>
                        </div>
                    </div>
                `;
            }).join('');
            area.scrollTop = area.scrollHeight;
        }

        function sendMessage(chatId, type, content) {
            const contact = appData.contacts.find(c => c.id == chatId);
            contact.conversation.push({
                id: Date.now(), sender: 'user', type, content, timestamp: Date.now()
            });
            saveData();
            renderMessages(chatId);
            
            // 模拟AI回复 (包含识图逻辑)
            if (type === 'image') {
                setTimeout(() => {
                    contact.conversation.push({
                        id: Date.now(), sender: 'char', type: 'text', 
                        content: { content: "哇，这张图真好看！(AI假装看懂了)" }, timestamp: Date.now()
                    });
                    saveData();
                    renderMessages(chatId);
                }, 1000);
            }
        }

        // 戳一戳
        function triggerPoke(chatId) {
            const contact = appData.contacts.find(c => c.id == chatId);
            const action = appData.settings.poke.userToChar.action;
            const suffix = appData.settings.poke.userToChar.suffix;
            const text = `"${appData.user.nickname}" ${action}了 "${contact.name}" ${suffix}`;
            
            contact.conversation.push({
                id: Date.now(), type: 'system', content: { content: text }, timestamp: Date.now()
            });
            saveData();
            renderMessages(chatId);
        }

        // 转发功能优化
        function showChatMenu(chatId) {
            const html = `
                <div class="modal-content">
                    <div class="list-view" style="background: transparent;">
                        <div class="list-item" onclick="simulateForward('${chatId}')">模拟转发消息 (测试)</div>
                        <div class="list-item" onclick="showApiLoader('delivery')">点外卖</div>
                    </div>
                    <button class="modal-btn" onclick="closeModal('chat-menu')">关闭</button>
                </div>
            `;
            showModal('chat-menu', html);
        }

        function simulateForward(chatId) {
            // 模拟生成一条包含多种类型的转发消息
            const contact = appData.contacts.find(c => c.id == chatId);
            const fakeMsgs = [
                { type: 'text', content: '你好' },
                { type: 'redPacket', remark: '恭喜发财' },
                { type: 'transfer', amount: '520.00' },
                { type: 'image', url: '' }
            ];
            
            const preview = fakeMsgs.map(m => {
                if(m.type==='text') return `我: ${m.content}`;
                if(m.type==='redPacket') return `我: [红包] ${m.remark}`;
                if(m.type==='transfer') return `我: [转账] ¥${m.amount}`;
                if(m.type==='image') return `我: [图片]`;
            });

            contact.conversation.push({
                id: Date.now(), sender: 'user', type: 'forward',
                content: { messages: fakeMsgs, preview }, timestamp: Date.now()
            });
            saveData();
            renderMessages(chatId);
            closeModal('chat-menu');
        }

        function showForwardDetail(msgId, chatId) {
            const contact = appData.contacts.find(c => c.id == chatId);
            const msg = contact.conversation.find(m => m.id == msgId);
            if (!msg) return;

            const html = `
                <div class="modal-content" style="height: 60vh;">
                    <div class="modal-title">聊天记录</div>
                    <div style="overflow-y: auto; height: calc(100% - 40px);">
                        ${msg.content.messages.map(m => {
                            let content = '';
                            if(m.type === 'text') content = m.content;
                            else if(m.type === 'redPacket') content = `<div style="color:orange;">[红包] ${m.remark}</div>`;
                            else if(m.type === 'transfer') content = `<div style="color:orange;">[转账] ¥${m.amount}</div>`;
                            else if(m.type === 'image') content = `[图片]`;
                            return `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; gap:10px;">
                                <img src="${appData.user.avatar}" style="width:30px;height:30px;border-radius:4px;">
                                <div><div style="font-size:12px;color:gray;">我</div><div>${content}</div></div>
                            </div>`;
                        }).join('')}
                    </div>
                    <button class="modal-btn" onclick="closeModal('forward-detail')">关闭</button>
                </div>
            `;
            showModal('forward-detail', html);
        }

        // API 加载动画
        function showApiLoader(type) {
            closeModal('chat-menu');
            const modalId = 'api-loader';
            const html = `
                <div class="modal-content" style="text-align: center;">
                    <div class="loading-spinner"></div>
                    <p>正在连接 ${type === 'delivery' ? '外卖' : '服务'} 平台...</p>
                </div>
            `;
            showModal(modalId, html);
            setTimeout(() => {
                closeModal(modalId);
                alert('模拟加载完成！(此处应展示商品列表)');
            }, 1500);
        }

        // 设置页面
        function renderSettingsAppPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i></div>
                    <span class="header-title">设置</span>
                </div>
                <div class="content-area">
                    <div class="list-item" onclick="showPage('beautify-page', renderBeautifyPage)">
                        <div class="details"><span class="name">美化功能</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('lock-settings-page', renderLockSettingsPage)">
                        <div class="details"><span class="name">锁屏设置</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('poke-settings-page', renderPokeSettingsPage)">
                        <div class="details"><span class="name">戳一戳设置</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }

        function renderBeautifyPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i></div>
                    <span class="header-title">美化功能</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>主屏/锁屏字体颜色</label>
                        <input type="color" id="clock-color-input" value="${appData.settings.beautify.homeClockColor}" style="width:100%; height:40px;">
                    </div>
                    <div class="form-group">
                        <label>更换锁屏壁纸</label>
                        <button class="form-btn" onclick="document.getElementById('lock-bg-input').click()">选择图片</button>
                        <input type="file" id="lock-bg-input" class="file-input" accept="image/*" onchange="handleImageUpload(this.files[0], 'lock')">
                    </div>
                    <button class="form-btn" onclick="saveBeautify()">保存生效</button>
                </div>
            `;
        }

        function saveBeautify() {
            appData.settings.beautify.homeClockColor = document.getElementById('clock-color-input').value;
            saveData();
            applyBeautifySettings();
            alert('设置已保存');
        }

        function renderLockSettingsPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i></div>
                    <span class="header-title">锁屏设置</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>启用密码锁</label>
                        <label class="switch"><input type="checkbox" id="lock-enable" ${appData.settings.lockScreen.enabled ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="form-group">
                        <label>设置4位数字密码</label>
                        <input type="number" id="lock-pwd" value="${appData.settings.lockScreen.password}" placeholder="例如: 1234" maxlength="4">
                    </div>
                    <button class="form-btn" onclick="saveLockSettings()">保存</button>
                </div>
            `;
        }

        function saveLockSettings() {
            const enabled = document.getElementById('lock-enable').checked;
            const pwd = document.getElementById('lock-pwd').value;
            if (enabled && pwd.length !== 4) { alert('请输入4位数字密码'); return; }
            appData.settings.lockScreen.enabled = enabled;
            appData.settings.lockScreen.password = pwd;
            saveData();
            alert('锁屏设置已更新');
        }

        function renderPokeSettingsPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i></div>
                    <span class="header-title">戳一戳设置</span>
                </div>
                <div class="content-area form-page">
                    <h3>我戳对方</h3>
                    <div class="form-group"><label>动作</label><input type="text" id="poke-user-action" value="${appData.settings.poke.userToChar.action}"></div>
                    <div class="form-group"><label>后缀</label><input type="text" id="poke-user-suffix" value="${appData.settings.poke.userToChar.suffix}"></div>
                    <button class="form-btn" onclick="savePokeSettings()">保存</button>
                </div>
            `;
        }

        function savePokeSettings() {
            appData.settings.poke.userToChar.action = document.getElementById('poke-user-action').value;
            appData.settings.poke.userToChar.suffix = document.getElementById('poke-user-suffix').value;
            saveData();
            alert('戳一戳设置已保存');
        }

        // 辅助函数
        function handleImageUpload(file, type) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                if (type === 'lock') appData.settings.lockScreen.wallpaper = e.target.result;
                saveData();
                applyBeautifySettings();
            };
            reader.readAsDataURL(file);
        }

        function applyBeautifySettings() {
            const root = document.documentElement;
            const b = appData.settings.beautify;
            root.style.setProperty('--home-clock-color', b.homeClockColor);
            root.style.setProperty('--lock-screen-background-image', `url(${appData.settings.lockScreen.wallpaper})`);
            root.style.setProperty('--home-screen-background-image', `url(${b.homeScreenWallpaper})`);
            // 应用图标
            renderHomeScreen(document.getElementById('home-screen-page'));
        }

        function showModal(id, html) {
            const container = document.getElementById('modal-container');
            const modal = document.createElement('div');
            modal.id = id;
            modal.className = 'modal-overlay';
            modal.innerHTML = html;
            modal.style.display = 'flex';
            container.appendChild(modal);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.remove();
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            const isActivated = localStorage.getItem('LPhoneActivated');
            if (isActivated) {
                document.getElementById('activation-modal').style.display = 'none';
                document.getElementById('phone-body').style.display = 'flex';
                initLockScreen();
                renderHomeScreen(document.getElementById('home-screen-page'));
            } else {
                document.getElementById('activation-btn').onclick = () => {
                    if (document.getElementById('activation-input').value.toUpperCase() === 'EVOL还是LOVE') {
                        localStorage.setItem('LPhoneActivated', 'true');
                        location.reload();
                    } else {
                        alert('激活码错误');
                    }
                };
            }
        });

        // 自动修复防火墙 (Mock)
        console.error = function() {}; // 静默错误
    </script>
</body>
</html>
