<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>梦女机</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            /* 屏幕尺寸 */
            --phone-width: 380px;
            --phone-height: 800px;

            /* 主题颜色变量 */
            --wechat-bg: #EDEDED;
            --wechat-nav-bg: #F6F6F6;
            --wechat-border-color: #D8D8D8;
            --wechat-text-primary: #000000;
            --wechat-text-secondary: #888888;
            --wechat-green: #07C160;
            --wechat-blue: #576B95;
            --wechat-red: #FA5151;
            --special-orange-bg: #FCAE3D; /* 统一的转账/红包浅橙色 */

            /* 美化变量 */
            --user-avatar-frame: none;
            --char-avatar-frame: none;
            --avatar-shape: 6px; /* 默认圆角 */
            --chat-background-image: none;
            --player-image: url('https://img.js.design/assets/img/664e0d45692271d43c087968.jpg');
            --player-background: url('https://img.js.design/assets/img/664e0d47e3a6821361b7829a.jpg');
            --user-custom-font: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
            --font-size-base: 15px;

            /* 手机边框变量 */
            --phone-border-color: #111;
            --phone-border-width: 10px;
            --phone-shadow: 0 15px 50px rgba(0,0,0,0.3);
            --phone-edge-highlight: transparent;
        }

        /* 夜间模式 */
        body.dark-mode {
            --wechat-bg: #121212;
            --wechat-nav-bg: #1E1E1E;
            --wechat-border-color: #3A3A3C;
            --wechat-text-primary: #EAEAEA;
            --wechat-text-secondary: #8E8E93;
        }
        body.dark-mode .message-row.received .message-bubble { background: #2C2C2E; color: #EAEAEA; }
        body.dark-mode .message-row.received .message-bubble::after { background: #2C2C2E; }
        body.dark-mode .list-item, body.dark-mode .me-profile-card, body.dark-mode .me-menu-item { background-color: #1E1E1E; }
        body.dark-mode .list-item:active { background-color: #121212; }
        body.dark-mode .form-group input, body.dark-mode .form-group textarea, body.dark-mode .form-group select { background: #3A3A3C; color: #EAEAEA; border-color: #3A3A3C; }
        body.dark-mode .modal-content { background: #2C2C2E; color: #EAEAEA; }
        body.dark-mode .modal-btn { background: #3A3A3C; color: #EAEAEA; border-color: #3A3A3C; }

        @font-face {
            font-family: 'UserCustomFont';
            src: var(--user-custom-font-src);
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #333;
            margin: 0;
            font-family: var(--user-custom-font);
            font-size: var(--font-size-base);
            overflow: hidden;
        }

        /* --- 手机外壳 --- */
        .phone-container {
            width: var(--phone-width);
            height: var(--phone-height);
            background: var(--phone-border-color);
            border-radius: 44px;
            box-shadow: var(--phone-shadow), 0 0 0 1px var(--phone-edge-highlight);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            border: var(--phone-border-width) solid var(--phone-border-color);
            transition: all 0.3s ease;
        }

        .screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: var(--wechat-bg);
            border-radius: 34px; /* 内部屏幕圆角 */
            overflow: hidden;
        }
        
        .page {
            position: absolute;
            inset: 0;
            background-color: var(--wechat-bg);
            display: none;
            flex-direction: column;
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        .page.active { display: flex; transform: translateX(0); }
        .page.no-transition { transition: none; }
        .page.sub-page { z-index: 200; }

        .wechat-header {
            height: 44px;
            background-color: var(--wechat-nav-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            border-bottom: 0.5px solid var(--wechat-border-color);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 10;
            color: var(--wechat-text-primary);
        }
        .header-title { font-size: 17px; font-weight: 600; position: absolute; left: 50%; transform: translateX(-50%); }
        .header-left, .header-right { display: flex; align-items: center; gap: 15px; font-size: 22px; cursor: pointer; color: var(--wechat-text-primary); }
        .header-back-btn { font-size: 17px; color: var(--wechat-text-primary); display: flex; align-items: center; gap: 2px; }
        .header-back-btn i { font-size: 20px; }

        .content-area { flex: 1; overflow-y: auto; }
        .content-area::-webkit-scrollbar { width: 4px; }
        .content-area::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }

        .wechat-tabbar { display: flex; height: 50px; background-color: var(--wechat-nav-bg); border-top: 0.5px solid var(--wechat-border-color); flex-shrink: 0; }
        .tab-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 2px; color: var(--wechat-text-secondary); cursor: pointer; }
        .tab-item.active { color: var(--wechat-green); }
        .tab-item i { font-size: 22px; }
        .tab-item span { font-size: 10px; }

        /* --- 通用列表 --- */
        .list-view { background-color: var(--wechat-nav-bg); }
        .list-item { 
            display: flex; 
            align-items: center; 
            padding: 10px 15px; 
            gap: 12px; 
            border-bottom: 0.5px solid var(--wechat-border-color);
            cursor: pointer; 
            position: relative; 
            background-color: var(--wechat-nav-bg);
        }
        .list-item:active { background-color: var(--wechat-bg); }
        .list-item .avatar { width: 48px; height: 48px; border-radius: var(--avatar-shape); object-fit: cover; }
        .list-item .details { flex: 1; overflow: hidden; }
        .list-item .details .name { font-size: var(--font-size-base); color: var(--wechat-text-primary); display: flex; align-items: center; gap: 5px; }
        .list-item .details .name .fa-star { color: #FFC300; font-size: 12px; }
        .list-item .details .subtext { font-size: calc(var(--font-size-base) - 2px); color: var(--wechat-text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item .info { text-align: right; font-size: calc(var(--font-size-base) - 3px); color: var(--wechat-text-secondary); }
        .list-divider { height: 8px; background-color: var(--wechat-bg); }
        .list-item .chevron { position: absolute; right: 15px; color: var(--wechat-text-secondary); }
        .list-item.pinned { background-color: var(--wechat-bg); }

        /* --- 我 页面 --- */
        #me-page .content-area { padding-top: 20px; }
        .me-profile-card { display: flex; align-items: center; gap: 20px; padding: 40px 20px 30px; background-color: var(--wechat-nav-bg); cursor: pointer; }
        .me-profile-card .avatar { width: 64px; height: 64px; border-radius: var(--avatar-shape); }
        .me-profile-card .details { flex: 1; }
        .me-profile-card .details .name { font-size: calc(var(--font-size-base) + 7px); font-weight: 600; margin-bottom: 5px; color: var(--wechat-text-primary); }
        .me-profile-card .details .wxid { color: var(--wechat-text-secondary); font-size: var(--font-size-base); }
        .me-profile-card .signature { font-size: calc(var(--font-size-base) - 1px); color: var(--wechat-text-secondary); margin-top: 5px; }
        .me-profile-card .qr-code { font-size: 20px; color: var(--wechat-text-secondary); }
        .me-menu-item { padding: 15px 20px; display: flex; align-items: center; gap: 20px; background-color: var(--wechat-nav-bg); cursor: pointer; }
        .me-menu-item:active { background-color: var(--wechat-bg); }
        .me-menu-item i { font-size: 24px; color: var(--wechat-blue); width: 24px; text-align: center; }
        .me-menu-item span { flex: 1; font-size: var(--font-size-base); color: var(--wechat-text-primary); }

        /* --- 聊天室 --- */
        #conversation-page .content-area { 
            background-color: var(--wechat-bg); 
            padding: 10px; 
            display: flex; 
            flex-direction: column;
            background-image: var(--chat-background-image);
            background-size: cover;
            background-position: center;
        }
        .message-row { display: flex; flex-direction: column; margin-bottom: 5px; max-width: 100%; }
        .message-timestamp { text-align: center; color: var(--wechat-text-secondary); font-size: calc(var(--font-size-base) - 3px); margin: 10px 0; }
        .message-recalled, .message-system { text-align: center; color: var(--wechat-text-secondary); font-size: calc(var(--font-size-base) - 3px); margin: 10px 0; background: rgba(0,0,0,0.1); padding: 4px 8px; border-radius: 4px; display: inline-block; align-self: center; }
        body.dark-mode .message-recalled, body.dark-mode .message-system { background: rgba(255,255,255,0.1); }
        .message-body { display: flex; align-items: flex-start; gap: 10px; }
        .message-row.sent { align-items: flex-end; }
        .message-row.sent .message-body { flex-direction: row-reverse; }
        .message-avatar-wrapper { position: relative; flex-shrink: 0; }
        .message-avatar { width: 40px; height: 40px; border-radius: var(--avatar-shape); cursor: pointer; }
        .avatar-frame { position: absolute; top: -5px; left: -5px; width: 50px; height: 50px; background-size: contain; background-repeat: no-repeat; pointer-events: none; }
        .message-row.sent .avatar-frame { background-image: var(--user-avatar-frame); }
        .message-row.received .avatar-frame { background-image: var(--char-avatar-frame); }
        .message-content-wrapper { display: flex; flex-direction: column; }
        .message-row.sent .message-content-wrapper { align-items: flex-end; }
        .message-row.received .message-content-wrapper { align-items: flex-start; }
        
        /* --- 气泡样式 --- */
        .message-bubble { 
            position: relative; 
            padding: 10px 14px; 
            font-size: var(--font-size-base); 
            line-height: 1.4; 
            max-width: calc(var(--phone-width) - 120px); 
            word-break: break-word; 
            border-radius: 6px; 
            user-select: none; 
            color: var(--wechat-text-primary); 
        }
        .message-bubble img { max-width: 150px; border-radius: 6px; display: block; }
        .message-bubble .quoted-message { background: rgba(0,0,0,0.05); padding: 5px 8px; border-radius: 4px; margin-bottom: 5px; border-left: 2px solid #ccc; font-size: calc(var(--font-size-base) - 2px); color: var(--wechat-text-secondary); }
        .message-bubble .quoted-message p { margin: 0; }
        .message-bubble.image-bubble { padding: 0; background: transparent !important; border-radius: 8px; overflow: hidden; }
        .message-bubble.image-bubble::after { display: none; }
        .sticker-message { background: transparent !important; padding: 0 !important; }
        .sticker-message img { max-width: 120px; max-height: 120px; }
        .sticker-message::after { display: none; }
        
        /* 模拟图片气泡 */
        .message-bubble.camera-sim-bubble {
            background: #fff;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .camera-sim-bubble .sim-icon { width: 30px; height: 30px; object-fit: contain; }
        .camera-sim-bubble .sim-text { font-size: 14px; color: #888; }
        body.dark-mode .message-bubble.camera-sim-bubble { background: #2c2c2e; }

        /* 位置气泡 */
        .message-bubble.location-bubble {
            background: #fff;
            padding: 0;
            display: flex;
            flex-direction: column;
            border: 0.5px solid #eee;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            width: 250px;
            overflow: hidden;
        }
        body.dark-mode .message-bubble.location-bubble { background: #2c2c2e; border-color: #3a3a3c; }
        .location-bubble .location-text-wrapper { padding: 10px; }
        .location-bubble .location-text { font-size: var(--font-size-base); color: var(--wechat-text-primary); word-break: break-all; }
        .location-bubble .map-placeholder { height: 100px; width: 100%; background-color: #f0f0f0; display: flex; justify-content: center; align-items: center; color: #aaa; font-size: 40px; }
        body.dark-mode .message-bubble.location-bubble .map-placeholder { background-color: #3a3a3c; }

        /* 语音气泡 */
        .message-bubble.voice-bubble { display: flex; align-items: center; gap: 8px; min-width: 80px; }
        .voice-bubble-content { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .voice-bubble-content .waveform { display: flex; align-items: center; height: 20px; overflow: hidden; }
        .voice-bubble-content .bar { width: 3px; height: 4px; background-color: var(--wechat-text-secondary); margin: 0 1.5px; border-radius: 2px; animation: wave 1.2s ease-in-out infinite alternate; }
        .message-row.sent .voice-bubble-content .bar { background-color: #000; }
        .message-row.received .voice-bubble-content .bar { background-color: var(--wechat-text-primary); }
        .voice-bubble-content .bar:nth-child(1) { animation-delay: 0s; } .voice-bubble-content .bar:nth-child(2) { animation-delay: 0.1s; } .voice-bubble-content .bar:nth-child(3) { animation-delay: 0.2s; } .voice-bubble-content .bar:nth-child(4) { animation-delay: 0.3s; } .voice-bubble-content .bar:nth-child(5) { animation-delay: 0.4s; } .voice-bubble-content .bar:nth-child(6) { animation-delay: 0.5s; } .voice-bubble-content .bar:nth-child(7) { animation-delay: 0.6s; } .voice-bubble-content .bar:nth-child(8) { animation-delay: 0.7s; } .voice-bubble-content .bar:nth-child(9) { animation-delay: 0.8s; } .voice-bubble-content .bar:nth-child(10) { animation-delay: 0.9s; }
        @keyframes wave { 0% { transform: scaleY(0.2); } 50% { transform: scaleY(1); } 100% { transform: scaleY(0.2); } }
        .voice-bubble-content .duration { font-size: 14px; color: var(--wechat-text-secondary); }
        .message-row.sent .voice-bubble-content .duration { color: #000; }

        /* 转账/红包气泡 */
        .transfer-bubble, .redpacket-bubble {
            background-color: var(--special-orange-bg);
            color: white;
            width: 230px;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }
        .transfer-bubble .main, .redpacket-bubble .main { display: flex; align-items: center; gap: 10px; }
        .transfer-bubble .icon, .redpacket-bubble .icon { font-size: 36px; color: white; }
        .transfer-bubble .details, .redpacket-bubble .details { display: flex; flex-direction: column; flex: 1; }
        .transfer-bubble .amount, .redpacket-bubble .amount { font-size: 18px; font-weight: 500; color: white; }
        .transfer-bubble .remark, .redpacket-bubble .remark { font-size: 14px; color: white; margin-top: 2px; }
        .transfer-bubble .footer, .redpacket-bubble .footer {
            font-size: 12px;
            color: white;
            padding-top: 8px;
            margin-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* 翻译/转文字/转发气泡 */
        .translated-text-bubble, .voice-transcribed-bubble, .forwarded-message-bubble { 
            background: var(--wechat-nav-bg);
            color: var(--wechat-text-primary); 
            padding: 10px 14px; 
            border-radius: 6px; 
            margin-top: 5px; 
            font-size: calc(var(--font-size-base) - 1px); 
            border: 0.5px solid var(--wechat-border-color); 
            max-width: calc(var(--phone-width) - 120px); 
            word-break: break-word;
        }
        .forwarded-message-bubble { cursor: pointer; }

        /* 时间戳样式 */
        .message-timestamp-under { font-size: calc(var(--font-size-base) - 3px); color: var(--wechat-text-secondary); margin-top: 4px; }
        .message-timestamp-inside { font-size: 10px; opacity: 0.7; margin-top: 5px; color: white; }
        .message-row.sent .message-bubble .message-timestamp-inside { color: #000; }

        /* 聊天输入栏 */
        .chat-input-bar { display: flex; align-items: center; padding: 8px 10px; gap: 10px; background: var(--wechat-nav-bg); border-top: 0.5px solid var(--wechat-border-color); }
        .chat-input-bar input { flex: 1; padding: 8px 12px; border: none; background: var(--wechat-bg); border-radius: 6px; font-size: var(--font-size-base); color: var(--wechat-text-primary); }
        body.dark-mode .chat-input-bar input { background: #3a3a3c; }
        .chat-input-bar i { font-size: 28px; cursor: pointer; color: var(--wechat-text-secondary); }
        .chat-plus-menu { position: absolute; bottom: 50px; left: 0; right: 0; background: var(--wechat-bg); display: none; grid-template-columns: repeat(4, 1fr); padding: 20px; gap: 20px; z-index: 10; border-top: 0.5px solid var(--wechat-border-color); }
        .plus-menu-item { display: flex; flex-direction: column; align-items: center; gap: 8px; font-size: calc(var(--font-size-base) - 3px); color: var(--wechat-text-secondary); cursor: pointer; }
        .plus-menu-item .icon { width: 56px; height: 56px; background: var(--wechat-nav-bg); border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 28px; color: var(--wechat-text-secondary); border: 0.5px solid var(--wechat-border-color); }

        /* --- 消息上下文菜单 --- */
        .message-context-menu { position: fixed; background: #4c4c4c; color: white; border-radius: 8px; padding: 5px; display: none; z-index: 1100; }
        .context-menu-item { padding: 8px 15px; cursor: pointer; white-space: nowrap; position: relative; font-size: var(--font-size-base); }
        .context-menu-item:hover { background: #666; }
        .context-submenu { display: none; position: absolute; left: 100%; top: 0; background: #4c4c4c; border-radius: 8px; padding: 5px; }
        .context-menu-item:hover .context-submenu { display: block; }

        /* --- 多选 --- */
        .multi-select-toolbar { position: fixed; bottom: 0; left: 0; right: 0; height: 50px; background: var(--wechat-nav-bg); border-top: 0.5px solid var(--wechat-border-color); display: none; justify-content: space-around; align-items: center; z-index: 1002; }
        .multi-select-toolbar.active { display: flex; }
        .multi-select-toolbar button { background: none; border: none; font-size: 16px; color: var(--wechat-text-primary); cursor: pointer; }
        .multi-select-toolbar button:disabled { color: var(--wechat-text-secondary); cursor: not-allowed; }
        .message-row.multi-select-mode .message-body::before { content: ''; display: block; width: 20px; height: 20px; border: 1px solid #ccc; border-radius: 50%; margin-right: 10px; align-self: center; flex-shrink: 0; }
        .message-row.multi-select-mode.selected .message-body::before { background-color: var(--wechat-green); border-color: var(--wechat-green); }
        .message-row.sent.multi-select-mode .message-body { flex-direction: row; } /* 修正多选框位置 */
        .message-row.sent.multi-select-mode .message-body::before { margin-left: 10px; margin-right: 0; order: 2; }
        .message-row.sent.multi-select-mode .message-body .message-avatar-wrapper { order: 3; }
        .message-row.sent.multi-select-mode .message-body .message-content-wrapper { order: 1; }

        /* --- 表单和模态框 --- */
        .form-page .content-area { padding: 15px; background-color: var(--wechat-bg); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: calc(var(--font-size-base) - 1px); color: var(--wechat-text-secondary); }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; padding: 10px; border: 1px solid var(--wechat-border-color); border-radius: 8px; 
            font-size: var(--font-size-base); box-sizing: border-box; background: var(--wechat-nav-bg); color: var(--wechat-text-primary); 
        }
        .form-group textarea { min-height: 200px; resize: vertical; }
        .form-btn { display: block; width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 17px; font-weight: 500; cursor: pointer; background-color: var(--wechat-green); color: white; text-align: center; margin-top: 20px; }
        .file-input { display: none; }
        .avatar-upload-preview { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; cursor: pointer; display: block; margin: 0 auto 20px; border: 1px solid var(--wechat-border-color); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--wechat-nav-bg); padding: 20px; border-radius: 12px; width: 85%; max-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color: var(--wechat-text-primary); }
        .modal-title { font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 20px; }
        .modal-input-group { margin-bottom: 15px; }
        .modal-input-group label { font-size: calc(var(--font-size-base) - 1px); color: var(--wechat-text-secondary); }
        .modal-input { width: 100%; padding: 10px; border: 1px solid var(--wechat-border-color); border-radius: 6px; box-sizing: border-box; font-size: var(--font-size-base); background: var(--wechat-bg); color: var(--wechat-text-primary); }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid var(--wechat-border-color); background: var(--wechat-bg); cursor: pointer; font-size: var(--font-size-base); color: var(--wechat-text-primary); }
        .modal-btn.primary { background: var(--wechat-green); color: #fff; border-color: var(--wechat-green); }

        /* --- 钱包页面 --- */
        #wallet-page .content-area { background-color: var(--wechat-bg); }
        .wallet-header { background-color: #63B466; color: white; padding: 30px 20px; }
        body.dark-mode .wallet-header { background-color: #2E7D32; }
        .wallet-balance-title { font-size: calc(var(--font-size-base) - 1px); opacity: 0.8; }
        .wallet-balance { font-size: calc(var(--font-size-base) + 25px); font-weight: bold; margin: 10px 0; word-break: break-all; }
        .wallet-main-actions { display: flex; background: var(--wechat-nav-bg); margin: 20px; border-radius: 8px; padding: 20px 0; }
        .wallet-main-action { flex: 1; text-align: center; border-right: 1px solid var(--wechat-border-color); cursor: pointer; }
        .wallet-main-action:last-child { border-right: none; }
        .wallet-main-action i { font-size: 28px; color: var(--wechat-green); }
        .wallet-main-action p { margin: 8px 0 0; font-size: var(--font-size-base); color: var(--wechat-text-primary); }

        /* --- 表情包 --- */
        #sticker-page .content-area { padding: 10px; }
        .sticker-pack { margin-bottom: 15px; }
        .sticker-pack-title { font-weight: bold; margin-bottom: 10px; padding: 0 5px; color: var(--wechat-text-primary); }
        .sticker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
        .sticker-item { background: transparent; border-radius: 8px; padding: 5px; cursor: pointer; display: flex; justify-content: center; align-items: center; aspect-ratio: 1 / 1; }
        .sticker-item img { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* --- 朋友圈 --- */
        #moments-page .content-area { background-color: var(--wechat-bg); padding-top: 0; }
        .moments-header-bg { height: 300px; background-size: cover; background-position: center; position: relative; cursor: pointer; }
        .moments-user-info { position: absolute; bottom: -20px; right: 20px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        .moments-user-info .name-avatar-wrapper { display: flex; align-items: center; gap: 15px; }
        .moments-user-info .name { color: white; font-size: 18px; font-weight: bold; text-shadow: 1px 1px 2px #000; }
        .moments-user-info .avatar { width: 70px; height: 70px; border-radius: var(--avatar-shape); border: 2px solid white; }
        .moments-signature { color: #ccc; font-size: 14px; text-shadow: 1px 1px 2px #000; max-width: 200px; text-align: right; }
        .moment-post { padding: 15px; border-bottom: 8px solid var(--wechat-bg); display: flex; gap: 10px; margin-top: 50px; background-color: var(--wechat-nav-bg); }
        .moment-post .avatar { width: 42px; height: 42px; border-radius: var(--avatar-shape); flex-shrink: 0; }
        .moment-post .post-content { flex: 1; }
        .moment-post .post-author { color: var(--wechat-blue); font-weight: 600; font-size: var(--font-size-base); }
        .moment-post .post-text { margin: 5px 0; font-size: var(--font-size-base); line-height: 1.5; white-space: pre-wrap; word-break: break-word; color: var(--wechat-text-primary); }
        .moment-post .post-media { margin-top: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .moment-post .post-media img, .moment-post .post-media video { width: 100%; height: 100px; object-fit: cover; border-radius: 6px; }
        .moment-post .post-media audio { width: 100%; margin-top: 5px; }
        .moment-post .post-meta { display: flex; justify-content: space-between; align-items: center; color: var(--wechat-text-secondary); font-size: calc(var(--font-size-base) - 2px); margin-top: 10px; }
        .moment-post .post-actions i { font-size: 20px; cursor: pointer; margin-left: 15px; }
        .moment-post .post-interactions { background: var(--wechat-bg); margin-top: 8px; border-radius: 4px; font-size: calc(var(--font-size-base) - 1px); }
        .moment-post .post-likes { padding: 8px 12px; border-bottom: 1px solid var(--wechat-border-color); color: var(--wechat-blue); }
        .moment-post .post-likes i { margin-right: 5px; }
        .moment-post .post-comments { padding: 8px 12px; }
        .moment-comment { margin-bottom: 3px; color: var(--wechat-text-primary); }
        .moment-comment .comment-author { color: var(--wechat-blue); font-weight: 600; cursor: pointer; }

        /* --- 开关控件 --- */
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--wechat-green); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- 群聊创建 --- */
        #create-group-chat-page .selected-contacts-preview { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border-bottom: 1px solid var(--wechat-border-color); }
        #create-group-chat-page .selected-contacts-preview .avatar { width: 40px; height: 40px; border-radius: var(--avatar-shape); }
        #create-group-chat-page .contact-selection-list .list-item { padding: 8px 15px; }
        #create-group-chat-page .contact-selection-list .list-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 10px; }
        #create-group-chat-page .contact-selection-list .list-item .details { flex: 1; }
        #create-group-chat-page .contact-selection-list .list-item .details .name { font-size: var(--font-size-base); }
        #create-group-chat-page .contact-selection-list .list-item .avatar { width: 36px; height: 36px; }
        #group-member-management-page .group-member-list .list-item { justify-content: space-between; }
        #group-member-management-page .group-member-list .list-item .member-actions button { padding: 5px 10px; border: 1px solid var(--wechat-border-color); border-radius: 4px; background: var(--wechat-bg); cursor: pointer; color: var(--wechat-text-primary); }

        /* --- 音乐播放器 --- */
        #music-player-page .content-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #222;
            color: white;
            padding: 20px;
            text-align: center;
            background-image: var(--player-background);
            background-size: cover;
            background-position: center;
            position: relative;
        }
        #music-player-page .content-area::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
        }
        #music-player-page .content-area > * { z-index: 1; }
        .music-cover {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            margin-bottom: 20px;
            animation: rotate 20s linear infinite;
            animation-play-state: paused;
            background-image: var(--player-image);
            background-size: cover;
            background-position: center;
            border: 5px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }
        .music-cover.playing { animation-play-state: running; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .music-info h3 { margin: 10px 0 5px; font-size: calc(var(--font-size-base) + 5px); }
        .music-info p { margin: 0; font-size: calc(var(--font-size-base) - 1px); color: #aaa; }
        .music-controls { display: flex; gap: 30px; margin-top: 30px; align-items: center; }
        .music-controls i { font-size: 36px; cursor: pointer; opacity: 0.8; transition: opacity 0.2s; }
        .music-controls i:hover { opacity: 1; }
        .music-controls .fa-play-circle, .music-controls .fa-pause-circle { font-size: 50px; }
        .music-progress { width: 80%; height: 4px; background: #555; margin-top: 20px; position: relative; border-radius: 2px; }
        .music-progress-bar { height: 100%; width: 0%; background: var(--wechat-green); border-radius: 2px; }
        .music-mode-toggle { font-size: 20px; margin-top: 20px; cursor: pointer; }

        /* 歌词页面 */
        #lyrics-page .content-area {
            background-color: #222;
            color: white;
            padding: 20px;
            text-align: center;
            overflow-y: auto;
        }
        .lyrics-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .lyrics-line {
            font-size: calc(var(--font-size-base) + 1px);
            margin: 15px 0;
            opacity: 0.5;
            transition: all 0.3s;
            color: white;
        }
        .lyrics-line.active {
            opacity: 1;
            font-size: calc(var(--font-size-base) + 4px);
            font-weight: bold;
            color: var(--wechat-red);
        }

        /* 缩小的音乐播放器弹窗 */
        .mini-player-overlay {
            position: fixed;
            bottom: 60px;
            right: 10px;
            width: 60px;
            height: 60px;
            z-index: 1000;
            cursor: grab;
        }
        .mini-player-overlay:active { cursor: grabbing; }
        .mini-player-cover {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            animation: rotate 10s linear infinite;
            animation-play-state: paused;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            background-image: var(--player-image);
            background-size: cover;
            background-position: center;
        }
        .mini-player-cover.playing { animation-play-state: running; }
        .mini-player-overlay .play-pause-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: white;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            padding: 5px;
            display: none; /* Initially hidden */
        }
        .mini-player-overlay:hover .play-pause-icon { display: block; }
        
        /* 聊天气泡CSS注入点 */
        #user-bubble-style {}
        #user-voice-bubble-style {}
    </style>
</head>
<body>
    <div class="phone-container" id="phone-body">
        <div class="screen">
            <!-- 主页面容器 -->
            <div id="main-container" class="page active no-transition">
                <div class="wechat-header" id="main-header">
                    <div class="header-left">
                        <i class="fas fa-plus-circle" id="main-plus-btn"></i>
                    </div>
                    <span class="header-title">微信</span>
                    <div class="header-right">
                        <!-- 搜索图标已根据要求删除 -->
                    </div>
                </div>
                <div class="content-area" id="main-content-area"></div>
                <div class="wechat-tabbar">
                    <div class="tab-item active" data-page="chat-list">
                        <i class="fas fa-comment-dots"></i>
                        <span>聊天</span>
                    </div>
                    <div class="tab-item" data-page="contacts">
                        <i class="fas fa-address-book"></i>
                        <span>通讯录</span>
                    </div>
                    <div class="tab-item" data-page="moments">
                        <i class="fas fa-compass"></i>
                        <span>朋友圈</span>
                    </div>
                    <div class="tab-item" data-page="me">
                        <i class="fas fa-user"></i>
                        <span>我</span>
                    </div>
                </div>
            </div>

            <!-- 页面容器 -->
            <div id="conversation-page" class="page sub-page"></div>
            <div id="editor-page" class="page sub-page form-page"></div>
            <div id="wallet-page" class="page sub-page"></div>
            <div id="transactions-page" class="page sub-page"></div>
            <div id="settings-page" class="page sub-page"></div>
            <div id="worldbook-page" class="page sub-page form-page"></div>
            <div id="beautify-page" class="page sub-page"></div>
            <div id="frame-settings-page" class="page sub-page"></div>
            <div id="bubble-settings-page" class="page sub-page form-page"></div>
            <div id="api-settings-page" class="page sub-page form-page"></div>
            <div id="sticker-page" class="page sub-page"></div>
            <div id="moments-page" class="page sub-page"></div>
            <div id="create-moment-page" class="page sub-page form-page"></div>
            <div id="chat-settings-page" class="page sub-page"></div>
            <div id="blacklist-page" class="page sub-page"></div>
            <div id="data-management-page" class="page sub-page"></div>
            <div id="create-group-chat-page" class="page sub-page"></div>
            <div id="group-chat-settings-page" class="page sub-page"></div>
            <div id="group-member-management-page" class="page sub-page"></div>
            <div id="music-player-page" class="page sub-page"></div>
            <div id="lyrics-page" class="page sub-page"></div>
            <div id="music-library-page" class="page sub-page"></div>
            <div id="music-settings-page" class="page sub-page"></div>
            <div id="player-beautify-page" class="page sub-page"></div>
            <div id="chat-mode-page" class="page sub-page"></div>
            <div id="font-settings-page" class="page sub-page form-page"></div>
            <div id="timestamp-settings-page" class="page sub-page"></div>
            <div id="theme-settings-page" class="page sub-page"></div>
            <div id="phone-frame-settings-page" class="page sub-page"></div>
            <div id="avatar-shape-settings-page" class="page sub-page"></div>
            <div id="screen-size-settings-page" class="page sub-page form-page"></div>

            <!-- 模态框容器 -->
            <div id="modal-container"></div>
            
            <!-- 消息上下文菜单 -->
            <div class="message-context-menu" id="message-context-menu"></div>

            <!-- 缩小的音乐播放器 -->
            <div id="mini-player" class="mini-player-overlay" style="display: none;">
                <div id="mini-player-cover" class="mini-player-cover"></div>
                <i class="fas fa-play play-pause-icon" id="mini-player-play-pause"></i>
            </div>
        </div>
    </div>

    <style id="user-bubble-style"></style>
    <style id="user-voice-bubble-style"></style>

    <script>
        // ========== 通用数据管理器 (IndexedDB) ==========
        class UniversalDataManager {
            constructor(dbName = 'WeChatSimulatorDB_v10', storeName = 'appDataStore') {
                this.dbName = dbName;
                this.storeName = storeName;
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    request.onerror = (event) => reject(`IndexedDB error: ${event.target.errorCode}`);
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName);
                        }
                    };
                });
            }

            async saveData(key, data) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.put(data, key);
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(`Save data error: ${event.target.error}`);
                });
            }

            async loadData(key) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(`Load data error: ${event.target.error}`);
                });
            }

            async exportAllData() {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get('appData');
                    request.onsuccess = () => resolve({ appData: request.result });
                    request.onerror = (event) => reject(`Export data error: ${event.target.error}`);
                });
            }

            async importFromBackup(backupData) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const clearRequest = store.clear();
                    clearRequest.onsuccess = () => {
                        const addRequest = store.add(backupData.appData, 'appData');
                        addRequest.onsuccess = () => resolve();
                        addRequest.onerror = (event) => reject(`Import (add) error: ${event.target.error}`);
                    };
                    clearRequest.onerror = (event) => reject(`Import (clear) error: ${event.target.error}`);
                });
            }
        }

        const dataManager = new UniversalDataManager();
        let appData;
        const DATA_KEY = 'appData';

        const defaultAppData = {
            user: {
                id: 'user', name: " ", avatar: "https://img.js.design/assets/img/6638e4537cf422dc287d398d.jpg",
                wxid: "Savilla_1107", persona: " ", signature: "不需要建议 不需要认同 我喜欢就值得",
                moments_bg: "https://source.unsplash.com/random/800x600?night",
                wallet: { balance: 1000000, transactions: [] }
            },
            contacts: [], groups: [], moments: [],
            stickers: { packs: [] },
            worldbooks: { presets: [], styles: [], library: [] },
            settings: {
                api: { provider: 'openai', endpoint: '', key: '', model: '', temperature: 0.7, top_p: 1.0 },
                beautify: {
                    phoneFrame: 'black', theme: 'normal', chatBackground: '',
                    userAvatarFrame: '', charAvatarFrame: '', avatarShape: '6px',
                    bubbleCss: `/* --- 经典微信气泡样式  --- */\n.message-row { gap: 10px; }\n.message-bubble { position: relative; padding: 10px 14px; font-size: 15px; line-height: 1.4; max-width: 100%; word-break: break-word; border-radius: 6px; }\n.message-row.sent .message-bubble { background: #96d35f; color: #000; }\n.message-row.received .message-bubble { background: #ffffff; color: #000; }\n.message-row.sent .message-bubble::after { content: ""; position: absolute; right: -6px; top: 12px; width: 8px; height: 12px; background: #96d35f; clip-path: polygon(0 0, 100% 50%, 0 100%); }\n.message-row.received .message-bubble::after { content: ""; position: absolute; left: -6px; top: 12px; width: 8px; height: 12px; background: #ffffff; clip-path: polygon(100% 0, 0 50%, 100% 100%); }`,
                    voiceBubbleCss: '',
                    fontUrl: '', fontFile: null, fontSize: 15,
                    screenWidth: 380, screenHeight: 800,
                },
                blacklist: [],
                charMomentFrequency: 'default',
                chatMode: 'online',
                timestampStyle: 'bubble-outside',
            },
            music: {
                library: [], favorites: [], currentSongId: null, isPlaying: false,
                playMode: 'sequence', playerImage: '', playerBackground: ''
            },
            activeChat: { id: null, type: null },
            version: '10.0'
        };

        async function loadData() {
            try {
                const savedData = await dataManager.loadData(DATA_KEY);
                appData = savedData ? savedData : JSON.parse(JSON.stringify(defaultAppData));
                // Data migration and validation
                if (!appData.settings.beautify.phoneFrame) appData.settings.beautify.phoneFrame = 'black';
                if (!appData.settings.beautify.avatarShape) appData.settings.beautify.avatarShape = '6px';
                if (!appData.settings.beautify.voiceBubbleCss) appData.settings.beautify.voiceBubbleCss = '';
                if (!appData.settings.beautify.screenWidth) appData.settings.beautify.screenWidth = 360;
                if (!appData.settings.beautify.screenHeight) appData.settings.beautify.screenHeight = 812;
                if (!appData.worldbooks) appData.worldbooks = { presets: [], styles: [], library: [] };
                if (!appData.user.wallet) appData.user.wallet = { balance: 1000000, transactions: [] };
                appData.contacts.forEach(c => {
                    if (c.isPinned === undefined) c.isPinned = false;
                    if (c.isStarred === undefined) c.isStarred = false;
                    if (c.lastMomentPostTime === undefined) c.lastMomentPostTime = 0;
                });
            } catch (error) {
                console.error("Failed to load data, using defaults.", error);
                appData = JSON.parse(JSON.stringify(defaultAppData));
            }
        }

        async function saveData(showAlert = false, callback = null) {
            try {
                await dataManager.saveData(DATA_KEY, appData);
                if (showAlert) {
                    alert('保存成功!');
                }
                if (callback) {
                    callback();
                }
            } catch (error) {
                console.error("Error saving data to IndexedDB:", error);
            }
        }

        // --- Navigation ---
        let pageHistory = ['main-container'];
        function showPage(pageId, renderFunc, ...args) {
            const pageElement = document.getElementById(pageId);
            if (!pageElement) return;

            if (renderFunc) {
                renderFunc(pageElement, ...args);
            }
            
            const currentPageEl = document.querySelector('.page.active');
            if (currentPageEl && currentPageEl.id !== pageId) {
                currentPageEl.classList.remove('active');
            }
            
            pageElement.classList.add('active');
            
            if (pageId !== pageHistory[pageHistory.length - 1]) {
                pageHistory.push(pageId);
            }
        }

        function goBack() {
            if (pageHistory.length <= 1) return;
            const currentPageId = pageHistory.pop();
            const previousPageId = pageHistory[pageHistory.length - 1];
            
            const currentPageEl = document.getElementById(currentPageId);
            if (currentPageEl) {
                currentPageEl.classList.remove('active');
            }
            
            const previousPageEl = document.getElementById(previousPageId);
            if (previousPageEl) {
                previousPageEl.classList.add('active');
            }
            
            if (previousPageId === 'main-container') {
                const activeTab = document.querySelector('.tab-item.active');
                if (activeTab) {
                    renderMainContent(activeTab.dataset.page);
                }
            }
        }

        // --- Rendering Functions ---
        function renderMainContent(pageType) {
            const contentArea = document.getElementById('main-content-area');
            const header = document.getElementById('main-header');
            const plusBtn = document.getElementById('main-plus-btn');
            
            contentArea.innerHTML = '';
            plusBtn.style.display = 'block';
            header.querySelector('.header-left').style.visibility = 'visible';

            switch (pageType) {
                case 'chat-list':
                    header.querySelector('.header-title').textContent = '微信';
                    renderChatListPage(contentArea);
                    plusBtn.onclick = () => showMainPlusMenu();
                    break;
                case 'contacts':
                    header.querySelector('.header-title').textContent = '通讯录';
                    renderContactsPage(contentArea);
                    plusBtn.onclick = () => showPage('editor-page', renderEditorPage, 'character');
                    break;
                case 'moments':
                    // Prevent bug where you can't go back from moments
                    if (pageHistory[pageHistory.length - 1] === 'moments-page') {
                        pageHistory.pop();
                    }
                    showPage('moments-page', renderMomentsPage);
                    break;
                case 'me':
                    header.querySelector('.header-title').textContent = '';
                    renderMePage(contentArea);
                    header.querySelector('.header-left').style.visibility = 'hidden';
                    break;
            }
        }

        function showMainPlusMenu() {
            const modalId = 'main-plus-menu-modal';
            const html = `
                <div class="modal-content">
                    <div class="list-view" style="background: transparent;">
                        <div class="list-item" onclick="showPage('create-group-chat-page', renderCreateGroupChatPage); closeModal('${modalId}');">
                            <i class="fas fa-users"></i><span style="margin-left: 10px;">发起群聊</span>
                        </div>
                        <div class="list-item" onclick="showPage('editor-page', renderEditorPage, 'character'); closeModal('${modalId}');">
                            <i class="fas fa-user-plus"></i><span style="margin-left: 10px;">添加朋友</span>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function renderChatListPage(container) {
            let html = '<div class="list-view">';
            const visibleContacts = appData.contacts.filter(c => !appData.settings.blacklist.includes(c.id));
            const allChats = [...visibleContacts.map(c => ({...c, type: 'individual'})), ...appData.groups.map(g => ({...g, type: 'group'}))];
            
            const sortedChats = [...allChats].sort((a, b) => {
                if (a.isPinned && !b.isPinned) return -1;
                if (!a.isPinned && b.isPinned) return 1;
                const lastMsgA = a.conversation?.[a.conversation.length - 1]?.timestamp || 0;
                const lastMsgB = b.conversation?.[b.conversation.length - 1]?.timestamp || 0;
                return lastMsgB - lastMsgA;
            });

            if (sortedChats.length === 0) {
                html += '<div style="text-align:center; padding: 50px; color: var(--wechat-text-secondary);">暂无聊天，去通讯录添加一个角色吧</div>';
            } else {
                sortedChats.forEach(chat => {
                    const lastMessage = chat.conversation && chat.conversation.length > 0
                        ? chat.conversation[chat.conversation.length - 1]
                        : { type: 'text', content: {content: '...'}, timestamp: chat.id };
                    const time = new Date(lastMessage.timestamp);
                    const displayTime = time.toLocaleDateString() === new Date().toLocaleDateString()
                        ? time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                        : `${time.getMonth()+1}/${time.getDate()}`;
                    
                    let subtext = '';
                    switch(lastMessage.type) {
                        case 'image': subtext = '[图片]'; break;
                        case 'sticker': subtext = '[表情]'; break;
                        case 'voice': subtext = '[语音]'; break;
                        case 'location': subtext = '[位置]'; break;
                        case 'transfer': subtext = '[转账]'; break;
                        case 'redPacket': subtext = '[红包]'; break;
                        case 'forward': subtext = '[聊天记录]'; break;
                        case 'camera-sim': subtext = '[图片]'; break;
                        default: subtext = lastMessage.content.content;
                    }

                    const displayName = chat.type === 'group' ? chat.name : (chat.remark || chat.name);
                    const starIcon = chat.isStarred ? '<i class="fas fa-star"></i>' : '';
                    const avatarSrc = chat.type === 'group' ? (chat.avatar || 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg') : chat.avatar;

                    html += `
                        <div class="list-item ${chat.isPinned ? 'pinned' : ''}" onclick="showPage('conversation-page', renderConversationPage, '${chat.id}', '${chat.type}')">
                            <img src="${avatarSrc}" class="avatar">
                            <div class="details">
                                <span class="name">${displayName} ${starIcon}</span>
                                <p class="subtext">${subtext ? subtext.substring(0, 25) : '...'}</p>
                            </div>
                            <div class="info">
                                <span>${displayTime}</span>
                            </div>
                        </div>
                    `;
                });
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function renderContactsPage(container) {
            let html = '<div class="list-view">';
            const visibleContacts = appData.contacts.filter(c => !appData.settings.blacklist.includes(c.id));
            visibleContacts.forEach(contact => {
                const displayName = contact.remark || contact.name;
                html += `
                    <div class="list-item" onclick="showPage('editor-page', renderEditorPage, 'character', ${contact.id})">
                        <img src="${contact.avatar}" class="avatar">
                        <div class="details">
                            <span class="name">${displayName}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function renderMePage(container) {
            const user = appData.user;
            container.innerHTML = `
                <div class="me-profile-card" onclick="showPage('editor-page', renderEditorPage, 'user')">
                    <img src="${user.avatar}" class="avatar">
                    <div class="details">
                        <p class="name">${user.name}</p>
                        <p class="wxid">微信号: ${user.wxid}</p>
                        <p class="signature">${user.signature}</p>
                    </div>
                    <i class="fas fa-qrcode qr-code"></i>
                </div>
                <div class="list-divider"></div>
                <div class="me-menu-item" onclick="showPage('wallet-page', renderWalletPage)">
                    <i class="fas fa-wallet" style="color: #07C160;"></i>
                    <span>钱包</span>
                    <i class="fas fa-chevron-right chevron"></i>
                </div>
                <div class="list-divider"></div>
                <div class="me-menu-item" onclick="showPage('moments-page', renderMomentsPage)">
                    <i class="fas fa-images" style="color: #576B95;"></i>
                    <span>朋友圈</span>
                    <i class="fas fa-chevron-right chevron"></i>
                </div>
                <div class="me-menu-item" onclick="showPage('sticker-page', renderStickerPage, true)">
                    <i class="far fa-grin" style="color: #FFC300;"></i>
                    <span>表情</span>
                    <i class="fas fa-chevron-right chevron"></i>
                </div>
                <div class="list-divider"></div>
                <div class="me-menu-item" onclick="showPage('settings-page', renderSettingsPage)">
                    <i class="fas fa-cog" style="color: #576B95;"></i>
                    <span>设置</span>
                    <i class="fas fa-chevron-right chevron"></i>
                </div>
            `;
        }

        function renderEditorPage(container, type, id = null) {
            const isUser = type === 'user';
            const target = isUser ? appData.user : appData.contacts.find(c => c.id == id);
            const title = isUser ? "编辑我的信息" : (target ? "编辑角色信息" : "新建角色");
            const personaLabel = isUser ? '我的人设 (AI会读取此设定)' : '角色设定 (Persona)';

            let avatarSrc = 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg';
            if (target) avatarSrc = target.avatar;

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()">
                        <i class="fas fa-chevron-left"></i>
                        <span>返回</span>
                    </div>
                    <span class="header-title">${title}</span>
                </div>
                <div class="content-area">
                    <img src="${avatarSrc}" class="avatar-upload-preview" id="editor-avatar-preview" onclick="document.getElementById('editor-avatar-input').click()">
                    <input type="file" id="editor-avatar-input" class="file-input" accept="image/*">
                    
                    <div class="form-group">
                        <label>名字</label>
                        <input type="text" id="editor-name" value="${target ? target.name : ''}">
                    </div>
                    ${isUser ? `
                    <div class="form-group">
                        <label>微信号</label>
                        <input type="text" id="editor-wxid" value="${target.wxid}">
                    </div>
                    <div class="form-group">
                        <label>个性签名</label>
                        <input type="text" id="editor-signature" value="${target.signature}">
                    </div>` : ''}
                    <div class="form-group">
                        <label>${personaLabel}</label>
                        <textarea id="editor-persona" style="min-height: 300px;">${target ? target.persona : ''}</textarea>
                    </div>
                    <button class="form-btn" id="editor-save-btn">保存</button>
                </div>
            `;

            document.getElementById('editor-avatar-input').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    document.getElementById('editor-avatar-preview').src = dataUrl;
                });
            };

            document.getElementById('editor-save-btn').onclick = () => {
                const newAvatar = document.getElementById('editor-avatar-preview').src;
                const newName = document.getElementById('editor-name').value.trim();
                const newPersona = document.getElementById('editor-persona').value.trim();

                if (!newName) { alert('名字不能为空'); return; }

                if (isUser) {
                    appData.user.avatar = newAvatar;
                    appData.user.name = newName;
                    appData.user.persona = newPersona;
                    appData.user.wxid = document.getElementById('editor-wxid').value.trim();
                    appData.user.signature = document.getElementById('editor-signature').value.trim();
                } else {
                    if (target) { // Edit existing
                        target.avatar = newAvatar;
                        target.name = newName;
                        target.persona = newPersona;
                    } else { // Create new
                        appData.contacts.push({
                            id: Date.now(), name: newName, avatar: newAvatar, persona: newPersona,
                            conversation: [], remark: '', isPinned: false, isStarred: false, lastMomentPostTime: 0
                        });
                    }
                }
                saveData(true, goBack);
            };
        }
        
        function renderConversationPage(container, chatId, chatType) {
            appData.activeChat.id = chatId;
            appData.activeChat.type = chatType;

            let chat;
            let displayName;
            if (chatType === 'group') {
                chat = appData.groups.find(g => g.id == chatId);
                displayName = `${chat.name} (${chat.members.length})`;
            } else {
                chat = appData.contacts.find(c => c.id == chatId);
                displayName = chat.remark || chat.name;
            }
            
            if (!chat) { goBack(); return; }

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()">
                        <i class="fas fa-chevron-left"></i>
                    </div>
                    <span class="header-title">${displayName}</span>
                    <div class="header-right" onclick="showPage('${chatType === 'group' ? 'group-chat-settings-page' : 'chat-settings-page'}', ${chatType === 'group' ? 'renderGroupChatSettingsPage' : 'renderChatSettingsPage'}, '${chatId}')"><i class="fas fa-ellipsis-h"></i></div>
                </div>
                <div class="content-area" id="message-area"></div>
                <div class="chat-input-bar">
                    <i class="fas fa-microphone" id="chat-voice-btn"></i>
                    <input type="text" id="chat-input" placeholder="发送消息">
                    <i class="far fa-grin" id="chat-sticker-btn"></i>
                    <i class="fas fa-plus-circle" id="chat-plus-btn"></i>
                </div>
                <div class="chat-plus-menu" id="chat-plus-menu">
                    <div class="plus-menu-item" id="plus-image-btn"><div class="icon"><i class="fas fa-image"></i></div><span>相册</span></div>
                    <div class="plus-menu-item" id="plus-camera-btn"><div class="icon"><i class="fas fa-camera"></i></div><span>拍摄</span></div>
                    <div class="plus-menu-item" id="plus-location-btn"><div class="icon"><i class="fas fa-map-marker-alt"></i></div><span>位置</span></div>
                    <div class="plus-menu-item" id="plus-redpacket-btn"><div class="icon" style="color: #E64340;"><i class="fas fa-envelope"></i></div><span>红包</span></div>
                    <div class="plus-menu-item" id="plus-transfer-btn"><div class="icon"><i class="fas fa-exchange-alt"></i></div><span>转账</span></div>
                    <div class="plus-menu-item" id="plus-music-btn"><div class="icon"><i class="fas fa-music"></i></div><span>一起听</span></div>
                </div>
                <div class="multi-select-toolbar" id="multi-select-toolbar">
                    <button id="multi-select-forward-btn" disabled>转发</button>
                    <button id="multi-select-delete-btn" disabled>删除</button>
                    <button id="multi-select-cancel-btn">取消</button>
                </div>
            `;
            
            renderMessages(chatId, chatType);

            const input = document.getElementById('chat-input');
            input.onkeydown = (e) => {
                if (e.key === 'Enter' && input.value.trim() !== '') {
                    e.preventDefault();
                    const quotedMessageId = input.dataset.quotedMessageId;
                    sendMessage(chatId, chatType, { content: input.value.trim() }, 'text', quotedMessageId);
                    input.value = '';
                    input.placeholder = '发送消息';
                    delete input.dataset.quotedMessageId;
                }
            };
            
            document.getElementById('chat-plus-btn').onclick = () => {
                const menu = document.getElementById('chat-plus-menu');
                menu.style.display = menu.style.display === 'grid' ? 'none' : 'grid';
            };
            
            document.getElementById('chat-voice-btn').onclick = () => showVoiceInputModal(chatId, chatType);
            document.getElementById('plus-image-btn').onclick = () => document.getElementById('image-file-input-chat').click();
            container.insertAdjacentHTML('beforeend', '<input type="file" id="image-file-input-chat" class="file-input" accept="image/*">');
            document.getElementById('image-file-input-chat').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    sendMessage(chatId, chatType, { url: dataUrl, description: "用户发送了一张图片" }, 'image');
                });
            };
            document.getElementById('plus-camera-btn').onclick = () => showCameraSimModal(chatId, chatType);
            document.getElementById('plus-location-btn').onclick = () => showLocationInputModal(chatId, chatType);
            document.getElementById('plus-transfer-btn').onclick = () => showTransactionModal('transfer', chatId, chatType);
            document.getElementById('plus-redpacket-btn').onclick = () => showTransactionModal('redPacket', chatId, chatType);
            document.getElementById('chat-sticker-btn').onclick = () => showPage('sticker-page', renderStickerPage, false);
            document.getElementById('plus-music-btn').onclick = () => showPage('music-library-page', renderMusicLibraryPage);

            // 多选功能
            let multiSelectMode = false;
            let selectedMessages = [];

            window.toggleMultiSelectMode = (enable, initialMessageId = null) => {
                multiSelectMode = enable;
                const toolbar = document.getElementById('multi-select-toolbar');
                const chatInputBar = document.querySelector('.chat-input-bar');
                const messageArea = document.getElementById('message-area');

                toolbar.classList.toggle('active', enable);
                chatInputBar.style.display = enable ? 'none' : 'flex';
                messageArea.querySelectorAll('.message-row').forEach(row => {
                    row.classList.toggle('multi-select-mode', enable);
                    row.classList.remove('selected');
                });

                if (enable) {
                    selectedMessages = [];
                    if (initialMessageId) {
                        selectedMessages.push(initialMessageId);
                        const initialRow = messageArea.querySelector(`.message-row[data-message-id="${initialMessageId}"]`);
                        if (initialRow) initialRow.classList.add('selected');
                    }
                }
                updateMultiSelectToolbar();
            };

            const updateMultiSelectToolbar = () => {
                const forwardBtn = document.getElementById('multi-select-forward-btn');
                const deleteBtn = document.getElementById('multi-select-delete-btn');
                const hasSelection = selectedMessages.length > 0;
                forwardBtn.disabled = !hasSelection;
                deleteBtn.disabled = !hasSelection;
            };

            document.getElementById('multi-select-forward-btn').onclick = () => {
                if (selectedMessages.length > 0) {
                    showForwardMessageModal(selectedMessages, chatId, chatType);
                    toggleMultiSelectMode(false);
                }
            };
            document.getElementById('multi-select-delete-btn').onclick = () => {
                if (selectedMessages.length > 0 && confirm(`确定要删除这 ${selectedMessages.length} 条消息吗？`)) {
                    let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
                    chat.conversation = chat.conversation.filter(msg => !selectedMessages.includes(msg.id));
                    saveData();
                    renderMessages(chatId, chatType);
                    toggleMultiSelectMode(false);
                }
            };
            document.getElementById('multi-select-cancel-btn').onclick = () => toggleMultiSelectMode(false);

            document.getElementById('message-area').addEventListener('click', e => {
                if (!multiSelectMode) return;
                const messageRow = e.target.closest('.message-row');
                if (messageRow) {
                    const messageId = parseInt(messageRow.dataset.messageId);
                    const index = selectedMessages.indexOf(messageId);
                    if (index > -1) {
                        selectedMessages.splice(index, 1);
                        messageRow.classList.remove('selected');
                    } else {
                        selectedMessages.push(messageId);
                        messageRow.classList.add('selected');
                    }
                    updateMultiSelectToolbar();
                }
            });
        }

        function renderMessages(chatId, chatType) {
            const container = document.getElementById('message-area');
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            if (!container || !chat) return;
            
            let html = '';
            let lastTimestamp = 0;
            (chat.conversation || []).forEach(msg => {
                if (appData.settings.timestampStyle === 'center' && msg.timestamp - lastTimestamp > 5 * 60 * 1000) {
                    html += `<div class="message-timestamp">${new Date(msg.timestamp).toLocaleString()}</div>`;
                    lastTimestamp = msg.timestamp;
                }

                if (msg.isRecalled) {
                    const recallerName = msg.sender === appData.user.id ? appData.user.name : (chatType === 'group' ? (chat.members.find(m => m.id === msg.sender)?.name || '未知成员') : (chat.remark || chat.name));
                    html += `<div class="message-recalled">${recallerName} 撤回了一条消息</div>`;
                    return;
                }
                if (msg.type === 'system') {
                    html += `<div class="message-system">${msg.content.content}</div>`;
                    return;
                }

                const isSent = msg.sender === appData.user.id;
                const senderObj = isSent ? appData.user : (chatType === 'group' ? (chat.members.find(m => m.id === msg.sender) || {name: '未知', avatar: ''}) : chat);
                if (!senderObj) return;

                const avatar = senderObj.avatar;
                let bubbleContent = '';
                let bubbleClass = '';
                let additionalContent = '';
                let timestampHtml = '';

                const msgTime = new Date(msg.timestamp);
                const timeString = msgTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second: '2-digit'});

                switch (appData.settings.timestampStyle) {
                    case 'bubble-outside': timestampHtml = `<div class="message-timestamp-under" style="text-align: ${isSent ? 'right' : 'left'};">${timeString}</div>`; break;
                    case 'avatar-under': timestampHtml = `<div class="message-timestamp-under" style="text-align: center;">${timeString}</div>`; break;
                }

                switch(msg.type) {
                    case 'image': bubbleContent = `<img src="${msg.content.url}" alt="image">`; bubbleClass = 'image-bubble'; break;
                    case 'sticker': bubbleContent = `<img src="${msg.content.url}" alt="sticker">`; bubbleClass = 'sticker-message'; break;
                    case 'voice':
                        bubbleContent = `<div class="voice-bubble-content"><div class="waveform">${Array(10).fill('<div class="bar"></div>').join('')}</div> <span>${msg.content.duration}"</span></div>`;
                        bubbleClass = 'voice-bubble';
                        if (msg.transcribedText) additionalContent = `<div class="voice-transcribed-bubble">${msg.transcribedText}</div>`;
                        break;
                    case 'location':
                        bubbleContent = `<div class="location-text-wrapper"><div class="location-text">${msg.content.location}</div></div><div class="map-placeholder"><i class="fas fa-map-marked-alt"></i></div>`;
                        bubbleClass = 'location-bubble';
                        break;
                    case 'camera-sim': 
                        bubbleContent = `<img src="https://i.postimg.cc/15MJnfvz/1040g3k031n53n96i4u005nji6r6g8nf12gtovao.jpg" class="sim-icon"><span class="sim-text">图片已被偷走……⚈₃⚈꧞</span>`; 
                        bubbleClass = 'camera-sim-bubble'; 
                        break;
                    case 'transfer':
                        let transferStatusText = '', transferFooter = '微信转账';
                        if (msg.content.status === 'sent') { transferStatusText = isSent ? '已转账' : '请你确认收款'; } 
                        else if (msg.content.status === 'claimed') { transferStatusText = '已收款'; } 
                        else if (msg.content.status === 'returned') { transferStatusText = '已退回'; }
                        if (chatType === 'group') transferFooter = `转账给 ${chat.members.find(m => m.id == msg.content.recipientId)?.name || '成员'}`;
                        bubbleContent = `<div class="main"><i class="fas fa-exchange-alt icon"></i><div class="details"><span class="amount">¥${parseFloat(msg.content.amount).toFixed(2)}</span><span class="remark">${transferStatusText}</span></div></div><div class="footer">${transferFooter}</div>`;
                        bubbleClass = 'transfer-bubble';
                        break;
                    case 'redPacket':
                        let packetStatus = msg.content.claimed.includes(appData.user.id) ? '已领取' : '点击领取红包';
                        if (msg.content.claimed.length >= msg.content.count) packetStatus = '红包已被领完';
                        bubbleContent = `<div class="main"><i class="fas fa-envelope icon"></i><div class="details"><span class="remark">${msg.content.remark}</span><span class="amount" style="font-size: 14px;">${isSent ? '查看红包' : packetStatus}</span></div></div><div class="footer">微信红包</div>`;
                        bubbleClass = 'redpacket-bubble';
                        break;
                    case 'forward': bubbleContent = `[聊天记录] ${msg.content.messages.length}条消息`; bubbleClass = 'forwarded-message-bubble'; break;
                    default: // text
                        let quotedHtml = '';
                        if (msg.quotedMessage) {
                            const quotedSenderName = msg.quotedMessage.sender === appData.user.id ? appData.user.name : (chat.remark || chat.name);
                            quotedHtml = `<div class="quoted-message"><p><strong>${quotedSenderName}:</strong> ${msg.quotedMessage.content.substring(0, 30)}...</p></div>`;
                        }
                        bubbleContent = `${quotedHtml}${msg.content.content}`;
                        if (msg.translatedText) additionalContent = `<div class="translated-text-bubble">${msg.translatedText}</div>`;
                        break;
                }

                if (appData.settings.timestampStyle === 'bubble-inside') {
                    bubbleContent += `<div class="message-timestamp-inside" style="text-align: ${isSent ? 'right' : 'left'};">${timeString}</div>`;
                }

                html += `
                    <div class="message-row ${isSent ? 'sent' : 'received'}" data-message-id="${msg.id}">
                        <div class="message-body">
                            <div class="message-avatar-wrapper">
                                <img src="${avatar}" class="message-avatar">
                                <div class="avatar-frame"></div>
                                ${appData.settings.timestampStyle === 'avatar-under' ? timestampHtml : ''}
                            </div>
                            <div class="message-content-wrapper">
                                <div class="message-bubble ${bubbleClass}" onclick="handleBubbleClick('${msg.type}', ${msg.id}, '${chatId}', '${chatType}')">${bubbleContent}</div>
                                ${additionalContent}
                                ${appData.settings.timestampStyle === 'bubble-outside' ? timestampHtml : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;

            document.querySelectorAll('.message-row[data-message-id]').forEach(row => {
                let pressTimer;
                const startPress = (e) => {
                    pressTimer = setTimeout(() => {
                        e.preventDefault();
                        showMessageContextMenu(e, parseInt(row.dataset.messageId), chatId, chatType);
                    }, 500);
                };
                const endPress = () => clearTimeout(pressTimer);
                
                row.addEventListener('mousedown', startPress);
                row.addEventListener('mouseup', endPress);
                row.addEventListener('mouseleave', endPress);
                row.addEventListener('touchstart', startPress);
                row.addEventListener('touchend', endPress);
            });
        }
        
        // --- Wallet & Settings & Beautify & Worldbook ---
        function renderWalletPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>我</span></div>
                    <span class="header-title">钱包</span>
                    <div class="header-right" style="font-size: 16px;" onclick="showPage('transactions-page', renderTransactionsPage)">收支明细</div>
                </div>
                <div class="content-area">
                    <div class="wallet-header">
                        <div class="wallet-balance-title">账户余额 (元)</div>
                        <div class="wallet-balance">${parseFloat(appData.user.wallet.balance).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                    </div>
                    <div class="wallet-main-actions">
                        <div class="wallet-main-action" onclick="showTransactionModal('deposit')"><i class="fas fa-plus-circle"></i><p>充值</p></div>
                        <div class="wallet-main-action" onclick="showTransactionModal('withdraw')"><i class="fas fa-arrow-circle-down"></i><p>提现</p></div>
                    </div>
                </div>
            `;
        }

        function renderTransactionsPage(container) {
            let html = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>钱包</span></div>
                    <span class="header-title">收支明细</span>
                </div>
                <div class="content-area"><div class="list-view">
            `;
            const transactions = appData.user.wallet.transactions.slice().reverse();
            if (transactions.length === 0) {
                html += '<div style="text-align:center; padding: 50px; color: var(--wechat-text-secondary);">暂无记录</div>';
            } else {
                transactions.forEach(tx => {
                    const isIncome = tx.amount > 0;
                    html += `
                        <div class="list-item">
                            <div class="details">
                                <span class="name">${tx.type}</span>
                                <p class="subtext">${new Date(tx.timestamp).toLocaleString()}</p>
                            </div>
                            <div class="info" style="color: ${isIncome ? 'var(--wechat-green)' : 'var(--wechat-text-primary)'}; font-size: var(--font-size-base); font-weight: 500;">
                                ${isIncome ? '+' : ''}${tx.amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </div>
                        </div>
                    `;
                });
            }
            html += '</div></div>';
            container.innerHTML = html;
        }

        function renderSettingsPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>我</span></div>
                    <span class="header-title">设置</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showPage('api-settings-page', renderApiSettingsPage)">
                        <div class="details"><span class="name">API 设置</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('worldbook-page', renderWorldbookPage)">
                        <div class="details"><span class="name">世界书</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('beautify-page', renderBeautifyPage)">
                        <div class="details"><span class="name">美化功能</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('blacklist-page', renderBlacklistPage)">
                        <div class="details"><span class="name">黑名单</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('data-management-page', renderDataManagementPage)">
                        <div class="details"><span class="name">数据备份与恢复</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showCharMomentFrequencySettings()">
                        <div class="details"><span class="name">AI动态频率</span></div>
                        <span class="info">${{'low': '较低', 'default': '默认', 'high': '较高'}[appData.settings.charMomentFrequency]}</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('chat-mode-page', renderChatModePage)">
                        <div class="details"><span class="name">聊天模式</span></div>
                        <span class="info">${appData.settings.chatMode === 'online' ? '线上聊天' : '线下剧情'}</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('timestamp-settings-page', renderTimestampSettingsPage)">
                        <div class="details"><span class="name">时间戳样式</span></div>
                        <span class="info">${{'center': '居中', 'bubble-outside': '气泡外', 'avatar-under': '头像下', 'bubble-inside': '气泡内'}[appData.settings.timestampStyle]}</span>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }

        function showCharMomentFrequencySettings() {
            const modalId = 'char-moment-frequency-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">AI动态频率</div>
                    <div class="list-view" style="background: transparent;">
                        <div class="list-item" onclick="setCharMomentFrequency('low'); closeModal('${modalId}')">较低 (每3天) ${appData.settings.charMomentFrequency === 'low' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}</div>
                        <div class="list-item" onclick="setCharMomentFrequency('default'); closeModal('${modalId}')">默认 (每1天) ${appData.settings.charMomentFrequency === 'default' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}</div>
                        <div class="list-item" onclick="setCharMomentFrequency('high'); closeModal('${modalId}')">较高 (每6小时) ${appData.settings.charMomentFrequency === 'high' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}</div>
                    </div>
                </div>`;
            showModal(modalId, html);
        }

        function setCharMomentFrequency(frequency) {
            appData.settings.charMomentFrequency = frequency;
            saveData();
            renderSettingsPage(document.getElementById('settings-page'));
        }

        function renderChatModePage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">聊天模式</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setChatMode('online')">
                        <div class="details"><span class="name">线上聊天</span><p class="subtext">模拟真实聊天，AI可能连续发送多条短消息 (10-25条)。</p></div>
                        ${appData.settings.chatMode === 'online' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setChatMode('offline')">
                        <div class="details"><span class="name">线下剧情</span><p class="subtext">专注于长篇剧情，AI会生成大段描述性文本 (8000-15000字)。</p></div>
                        ${appData.settings.chatMode === 'offline' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setChatMode(mode) {
            appData.settings.chatMode = mode;
            saveData();
            renderChatModePage(document.getElementById('chat-mode-page'));
            renderSettingsPage(document.getElementById('settings-page'));
        }

        function renderTimestampSettingsPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">时间戳样式</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setTimestampStyle('center')">
                        <div class="details"><span class="name">时间戳居中 (每5分钟)</span></div>
                        ${appData.settings.timestampStyle === 'center' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTimestampStyle('bubble-outside')">
                        <div class="details"><span class="name">时间戳在气泡外</span></div>
                        ${appData.settings.timestampStyle === 'bubble-outside' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTimestampStyle('avatar-under')">
                        <div class="details"><span class="name">时间戳在头像下</span></div>
                        ${appData.settings.timestampStyle === 'avatar-under' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTimestampStyle('bubble-inside')">
                        <div class="details"><span class="name">时间戳在气泡内</span></div>
                        ${appData.settings.timestampStyle === 'bubble-inside' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setTimestampStyle(style) {
            appData.settings.timestampStyle = style;
            saveData();
            renderTimestampSettingsPage(document.getElementById('timestamp-settings-page'));
            renderSettingsPage(document.getElementById('settings-page'));
        }
        
        function renderWorldbookPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">世界书</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showWorldbookEditor('presets')">
                        <div class="details"><span class="name">预设</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showWorldbookEditor('styles')">
                        <div class="details"><span class="name">文风</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showWorldbookEditor('library')">
                        <div class="details"><span class="name">世界书库</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }

        function showWorldbookEditor(type) {
            const typeMap = { presets: '预设', styles: '文风', library: '世界书库' };
            const items = appData.worldbooks[type];
            const modalId = 'worldbook-editor-modal';
            const content = `
                <div class="modal-content" style="width: 95%; max-width: 400px;">
                    <div class="modal-title">${typeMap[type]} <i class="fas fa-plus-circle" style="cursor:pointer; color: var(--wechat-green);" onclick="editWorldbookItem('${type}')"></i></div>
                    <div class="list-view" style="max-height: 60vh; overflow-y: auto; background: transparent;">
                        ${items.map(item => `
                            <div class="list-item" onclick="editWorldbookItem('${type}', ${item.id})">
                                <div class="details"><span class="name">${item.name}</span></div>
                                <i class="fas fa-trash-alt" style="color: var(--wechat-red);" onclick="event.stopPropagation(); deleteWorldbookItem('${type}', ${item.id})"></i>
                            </div>
                        `).join('') || `<p style="text-align:center; padding: 20px;">暂无内容</p>`}
                    </div>
                    <button class="modal-btn" onclick="closeModal('${modalId}')" style="margin-top: 15px;">关闭</button>
                </div>
            `;
            showModal(modalId, content);
        }

        function editWorldbookItem(type, id = null) {
            const isNew = id === null;
            const item = isNew ? { id: Date.now(), name: '', content: '' } : appData.worldbooks[type].find(i => i.id === id);
            if (!item) return;
            const typeMap = { presets: '预设', styles: '文风', library: '世界书' };
            const title = (isNew ? '新建' : '编辑') + typeMap[type];
            const modalId = 'worldbook-item-editor';
            const content = `
                <div class="modal-content" style="width: 95%; max-width: 400px;">
                    <div class="modal-title">${title}</div>
                    <div class="form-group">
                        <label>名称</label>
                        <input type="text" id="wb-edit-name" class="modal-input" value="${item.name}">
                    </div>
                    <div class="form-group">
                        <label>内容 (无字数上限)</label>
                        <textarea id="wb-edit-content" class="modal-input" style="height: 40vh;">${item.content}</textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" onclick="saveWorldbookItem('${type}', ${id}, ${isNew})">保存</button>
                    </div>
                </div>
            `;
            showModal(modalId, content);
        }

        function saveWorldbookItem(type, id, isNew) {
            const name = document.getElementById('wb-edit-name').value;
            const content = document.getElementById('wb-edit-content').value;
            if (!name) { alert('名称不能为空'); return; }
            if (isNew) {
                appData.worldbooks[type].push({ id: Date.now(), name, content });
            } else {
                const index = appData.worldbooks[type].findIndex(i => i.id === id);
                if (index > -1) appData.worldbooks[type][index] = { id, name, content };
            }
            saveData();
            closeModal('worldbook-item-editor');
            showWorldbookEditor(type); // Refresh the list
        }

        function deleteWorldbookItem(type, id) {
            if (!confirm('确定删除吗？')) return;
            appData.worldbooks[type] = appData.worldbooks[type].filter(i => i.id !== id);
            saveData();
            showWorldbookEditor(type); // Refresh the list
        }

        function renderBeautifyPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">美化功能</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showPage('theme-settings-page', renderThemeSettingsPage)">
                        <div class="details"><span class="name">主题美化</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('screen-size-settings-page', renderScreenSizeSettingsPage)">
                        <div class="details"><span class="name">屏幕尺寸</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('phone-frame-settings-page', renderPhoneFrameSettingsPage)">
                        <div class="details"><span class="name">手机边框</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="document.getElementById('chat-bg-input').click()">
                        <div class="details"><span class="name">更换聊天背景图</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <input type="file" id="chat-bg-input" class="file-input" accept="image/*" onchange="handleChatBgUpload(this.files[0])">
                    <div class="list-item" onclick="showPage('font-settings-page', renderFontSettingsPage)">
                        <div class="details"><span class="name">更换字体</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('avatar-shape-settings-page', renderAvatarShapeSettingsPage)">
                        <div class="details"><span class="name">头像形状</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('frame-settings-page', renderFrameSettingsPage)">
                        <div class="details"><span class="name">更换头像框</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('bubble-settings-page', renderBubbleSettingsPage)">
                        <div class="details"><span class="name">聊天气泡CSS</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }

        function handleChatBgUpload(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                appData.settings.beautify.chatBackground = e.target.result;
                saveData(true);
                applyBeautifySettings();
            };
            reader.readAsDataURL(file);
        }

        function renderThemeSettingsPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">主题美化</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setTheme('normal')">
                        <div class="details"><span class="name">正常模式</span></div>
                        ${appData.settings.beautify.theme === 'normal' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setTheme('dark')">
                        <div class="details"><span class="name">夜间模式</span></div>
                        ${appData.settings.beautify.theme === 'dark' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setTheme(theme) {
            appData.settings.beautify.theme = theme;
            saveData();
            applyBeautifySettings();
            renderThemeSettingsPage(document.getElementById('theme-settings-page'));
        }

        function renderScreenSizeSettingsPage(container) {
            const b = appData.settings.beautify;
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">屏幕尺寸</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>屏幕宽度 (px)</label>
                        <input type="number" id="screen-width-input" value="${b.screenWidth}">
                    </div>
                    <div class="form-group">
                        <label>屏幕高度 (px)</label>
                        <input type="number" id="screen-height-input" value="${b.screenHeight}">
                    </div>
                    <button class="form-btn" id="save-screen-size-btn">应用</button>
                </div>
            `;
            document.getElementById('save-screen-size-btn').onclick = () => {
                b.screenWidth = parseInt(document.getElementById('screen-width-input').value);
                b.screenHeight = parseInt(document.getElementById('screen-height-input').value);
                saveData(true);
                applyBeautifySettings();
            };
        }

        function renderPhoneFrameSettingsPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">手机边框</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    ${['white', 'black', 'simple-white', 'pink', 'transparent', 'stereo'].map(frame => `
                    <div class="list-item" onclick="setPhoneFrame('${frame}')">
                        <div class="details"><span class="name">${{white:'白色', black:'黑色', 'simple-white':'简约白', pink:'粉色', transparent:'透明', stereo:'增强立体'}[frame]}</span></div>
                        ${appData.settings.beautify.phoneFrame === frame ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>`).join('')}
                </div>
            `;
        }

        function setPhoneFrame(frame) {
            appData.settings.beautify.phoneFrame = frame;
            saveData();
            applyBeautifySettings();
            renderPhoneFrameSettingsPage(document.getElementById('phone-frame-settings-page'));
        }

        function renderAvatarShapeSettingsPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">头像形状</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setAvatarShape('6px')">
                        <div class="details"><span class="name">圆角</span></div>
                        ${appData.settings.beautify.avatarShape === '6px' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                    <div class="list-item" onclick="setAvatarShape('50%')">
                        <div class="details"><span class="name">圆形</span></div>
                        ${appData.settings.beautify.avatarShape === '50%' ? '<i class="fas fa-check" style="color: var(--wechat-green);"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function setAvatarShape(shape) {
            appData.settings.beautify.avatarShape = shape;
            saveData();
            applyBeautifySettings();
            renderAvatarShapeSettingsPage(document.getElementById('avatar-shape-settings-page'));
        }

        function renderFontSettingsPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">更换字体</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>字体URL链接 (.ttf, .woff, .woff2)</label>
                        <input type="text" id="font-url-input" value="${appData.settings.beautify.fontUrl || ''}">
                    </div>
                    <div class="form-group">
                        <label>或从本地文件导入 (.ttf, .woff, .woff2)</label>
                        <button class="form-btn" style="background-color: #aaa;" onclick="document.getElementById('font-file-input').click()">选择文件</button>
                        <input type="file" id="font-file-input" class="file-input" accept=".ttf,.woff,.woff2">
                    </div>
                    <div class="form-group">
                        <label>字体大小 (<span id="font-size-display">${appData.settings.beautify.fontSize}px</span>)</label>
                        <input type="range" id="font-size-input" min="10" max="30" value="${appData.settings.beautify.fontSize}" oninput="document.getElementById('font-size-display').textContent = this.value + 'px'">
                    </div>
                    <button class="form-btn" id="save-font-btn">保存并应用</button>
                </div>
            `;
            document.getElementById('save-font-btn').onclick = () => {
                const url = document.getElementById('font-url-input').value.trim();
                const fileInput = document.getElementById('font-file-input');
                const file = fileInput.files[0];
                const fontSize = parseInt(document.getElementById('font-size-input').value);

                appData.settings.beautify.fontSize = fontSize;

                const applyAndSave = () => {
                    saveData(true);
                    applyBeautifySettings();
                };

                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        appData.settings.beautify.fontFile = e.target.result;
                        appData.settings.beautify.fontUrl = '';
                        applyAndSave();
                    };
                    reader.readAsDataURL(file);
                } else {
                    appData.settings.beautify.fontUrl = url;
                    appData.settings.beautify.fontFile = null;
                    applyAndSave();
                }
            };
        }

        function renderFrameSettingsPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">更换头像框</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showFrameEditor('user')">
                        <div class="details"><span class="name">更换我的头像框</span></div>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showFrameEditor('char')">
                        <div class="details"><span class="name">更换对方的头像框</span></div>
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }
        
        function showFrameEditor(type) {
            const title = type === 'user' ? '更换我的头像框' : '更换对方的头像框';
            const currentFrame = type === 'user' ? appData.settings.beautify.userAvatarFrame : appData.settings.beautify.charAvatarFrame;
            const modalId = 'frame-editor-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">${title}</div>
                    <img src="${currentFrame || 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg'}" class="avatar-upload-preview" id="frame-preview-modal" onclick="document.getElementById('frame-input-modal').click()">
                    <input type="file" id="frame-input-modal" class="file-input" accept="image/*">
                    <div class="modal-actions">
                        <button class="modal-btn" id="remove-frame-btn-modal">移除</button>
                        <button class="modal-btn primary" id="save-frame-btn-modal">保存</button>
                    </div>
                    <button class="modal-btn" onclick="closeModal('${modalId}')" style="margin-top: 10px; background: #eee;">关闭</button>
                </div>
            `;
            showModal(modalId, html);

            document.getElementById('frame-input-modal').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    document.getElementById('frame-preview-modal').src = dataUrl;
                });
            };
            document.getElementById('save-frame-btn-modal').onclick = () => {
                const newFrame = document.getElementById('frame-preview-modal').src;
                if (type === 'user') appData.settings.beautify.userAvatarFrame = newFrame;
                else appData.settings.beautify.charAvatarFrame = newFrame;
                saveData(true);
                applyBeautifySettings();
                closeModal(modalId);
            };
            document.getElementById('remove-frame-btn-modal').onclick = () => {
                if (type === 'user') appData.settings.beautify.userAvatarFrame = '';
                else appData.settings.beautify.charAvatarFrame = '';
                saveData(true);
                applyBeautifySettings();
                document.getElementById('frame-preview-modal').src = 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg';
                closeModal(modalId);
            };
        }

        function renderBubbleSettingsPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">聊天气泡CSS</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>通用气泡CSS</label>
                        <textarea id="bubble-css-input" style="height: 200px;">${appData.settings.beautify.bubbleCss}</textarea>
                    </div>
                    <div class="form-group">
                        <label>语音气泡CSS (会覆盖通用样式)</label>
                        <textarea id="voice-bubble-css-input" style="height: 200px;">${appData.settings.beautify.voiceBubbleCss}</textarea>
                    </div>
                    <button class="form-btn" id="save-bubble-btn">保存并应用</button>
                </div>
            `;
            document.getElementById('save-bubble-btn').onclick = () => {
                appData.settings.beautify.bubbleCss = document.getElementById('bubble-css-input').value;
                appData.settings.beautify.voiceBubbleCss = document.getElementById('voice-bubble-css-input').value;
                saveData(true);
                applyBeautifySettings();
            };
        }

        function renderApiSettingsPage(container) {
            const providers = {
                'openai': 'OpenAI', 'claude': 'Claude (Anthropic)', 'gemini': 'Gemini (Google AI Studio)',
                'deepseek': 'DeepSeek', 'openrouter': 'OpenRouter', 'grok': 'Grok (xAI)',
                'doubao': 'Doubao (豆包)', 'custom': '自定义 (OpenAI)', 'custom_gemini': '自定义 (Gemini)'
            };
            const api = appData.settings.api;
            let providerOptions = '';
            for (const key in providers) {
                providerOptions += `<option value="${key}" ${api.provider === key ? 'selected' : ''}>${providers[key]}</option>`;
            }

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">API设置</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>供应商</label>
                        <select id="api-provider">${providerOptions}</select>
                    </div>
                    <div class="form-group">
                        <label>API端点 (Endpoint URL)</label>
                        <input type="text" id="api-endpoint" value="${api.endpoint}" placeholder="例如: https://api.openai.com/v1">
                    </div>
                    <div class="form-group">
                        <label>密钥 (API Key)</label>
                        <input type="password" id="api-key" value="${api.key}">
                    </div>
                    <div class="form-group">
                        <label>模型</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="api-model" value="${api.model}" style="flex: 1;" placeholder="例如: gpt-4-turbo">
                            <button id="fetch-models-btn" style="padding: 10px;">获取</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Temperature: <span id="temp-value">${api.temperature}</span></label>
                        <input type="range" id="temperature" min="0" max="2" step="0.1" value="${api.temperature}" oninput="document.getElementById('temp-value').textContent = this.value">
                    </div>
                    <div class="form-group">
                        <label>Top P: <span id="topp-value">${api.top_p}</span></label>
                        <input type="range" id="top-p" min="0" max="1" step="0.01" value="${api.top_p}" oninput="document.getElementById('topp-value').textContent = this.value">
                    </div>
                    <button class="form-btn" id="save-api-btn">保存设置</button>
                </div>
            `;

            document.getElementById('fetch-models-btn').onclick = fetchModels;
            document.getElementById('save-api-btn').onclick = () => {
                appData.settings.api = {
                    provider: document.getElementById('api-provider').value,
                    endpoint: document.getElementById('api-endpoint').value.trim(),
                    key: document.getElementById('api-key').value.trim(),
                    model: document.getElementById('api-model').value.trim(),
                    temperature: parseFloat(document.getElementById('temperature').value),
                    top_p: parseFloat(document.getElementById('top-p').value)
                };
                saveData(true);
            };
        }

        function renderStickerPage(container, isManagement = false) {
            let headerHtml = isManagement ? `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>我</span></div>
                    <span class="header-title">我的表情</span>
                    <div class="header-right" onclick="showStickerImportModal()"><i class="fas fa-plus"></i></div>
                </div>
            ` : `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">选择表情</span>
                </div>
            `;

            let bodyHtml = '';
            if (appData.stickers.packs.length === 0) {
                bodyHtml = '<div style="text-align:center; padding: 50px; color: var(--wechat-text-secondary);">还没有表情包，快去添加吧</div>';
            } else {
                appData.stickers.packs.forEach(pack => {
                    bodyHtml += `<div class="sticker-pack">
                        <div class="sticker-pack-title">${pack.name}</div>
                        <div class="sticker-grid">
                            ${pack.stickers.map(sticker => `
                                <div class="sticker-item" onclick="sendSticker('${sticker.url}')">
                                    <img src="${sticker.url}" loading="lazy">
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                });
            }
            container.innerHTML = headerHtml + `<div class="content-area">${bodyHtml}</div>`;
        }

        // --- Modals ---
        function showModal(id, html) {
            const container = document.getElementById('modal-container');
            const modal = document.createElement('div');
            modal.id = id;
            modal.className = 'modal-overlay';
            modal.innerHTML = html;
            modal.style.display = 'flex';
            container.appendChild(modal);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.remove();
        }

        function showTransactionModal(type, chatId, chatType) {
            const isFinancial = type === 'deposit' || type === 'withdraw';
            const title = { deposit: '充值', withdraw: '提现', transfer: '转账', redPacket: '发红包' }[type];
            const amountLimit = { withdraw: 5000000, transfer: 5000000, redPacket: 200 }[type];
            const remarkNeeded = type === 'transfer' || type === 'redPacket';
            
            const modalId = 'transaction-modal';
            let memberSelectionHtml = '';
            let recipientCountInput = '';

            if (chatType === 'group' && (type === 'transfer' || type === 'redPacket')) {
                const group = appData.groups.find(g => g.id == chatId);
                const members = group.members.filter(m => m.id !== appData.user.id);
                if (type === 'transfer') {
                    memberSelectionHtml = `
                        <div class="modal-input-group">
                            <label>转账给</label>
                            <select id="tx-recipient" class="modal-input">
                                ${members.map(m => `<option value="${m.id}">转账给 ${m.name}</option>`).join('')}
                            </select>
                        </div>
                    `;
                } else if (type === 'redPacket') {
                    recipientCountInput = `
                        <div class="modal-input-group">
                            <label>红包个数</label>
                            <input type="number" id="redpacket-count" class="modal-input" value="1" min="1" max="${members.length}">
                        </div>
                    `;
                }
            }

            const html = `
                <div class="modal-content">
                    <div class="modal-title">${title}</div>
                    ${memberSelectionHtml}
                    ${recipientCountInput}
                    <div class="modal-input-group">
                        <label>金额 (元)</label>
                        <input type="number" id="tx-amount" class="modal-input" placeholder="${amountLimit ? `0.01 ~ ${amountLimit.toFixed(2)}` : '请输入金额'}">
                    </div>
                    ${remarkNeeded ? `
                    <div class="modal-input-group">
                        <label>备注</label>
                        <input type="text" id="tx-remark" class="modal-input" maxlength="20" placeholder="最多20字">
                    </div>` : ''}
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="confirm-tx-btn">确认</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);

            document.getElementById('confirm-tx-btn').onclick = () => {
                const amountInput = document.getElementById('tx-amount');
                const amount = parseFloat(amountInput.value);
                if (isNaN(amount) || amount < 0.01) { alert("请输入有效的金额"); return; }
                if (amountLimit && amount > amountLimit) { alert(`金额不能超过 ${amountLimit.toFixed(2)}`); return; }

                const wallet = appData.user.wallet;
                if (isFinancial) {
                    if (type === 'withdraw') {
                        if (amount > wallet.balance) { alert("余额不足"); return; }
                        wallet.balance -= amount;
                        wallet.transactions.push({ type: '提现', amount: -amount, timestamp: Date.now() });
                    } else { // deposit
                        wallet.balance += amount;
                        wallet.transactions.push({ type: '充值', amount: amount, timestamp: Date.now() });
                    }
                    renderWalletPage(document.getElementById('wallet-page'));
                } else { // Chat transaction
                    if (amount > wallet.balance) { alert("余额不足"); return; }
                    
                    const remark = document.getElementById('tx-remark')?.value.trim() || (type === 'redPacket' ? '恭喜发财，大吉大利' : '');
                    
                    let recipientId = null;
                    let redPacketCount = 1;

                    if (chatType === 'group') {
                        if (type === 'transfer') {
                            recipientId = document.getElementById('tx-recipient').value;
                        } else if (type === 'redPacket') {
                            redPacketCount = parseInt(document.getElementById('redpacket-count').value);
                            if (isNaN(redPacketCount) || redPacketCount < 1) { alert("红包个数无效"); return; }
                            const group = appData.groups.find(g => g.id == chatId);
                            if (redPacketCount > group.members.length - 1) { alert(`红包个数不能超过群成员数 (${group.members.length - 1})`); return; }
                        }
                    } else if (chatType === 'individual') {
                        recipientId = chatId;
                    }

                    if (type === 'transfer') {
                        wallet.balance -= amount;
                        const targetName = chatType === 'group' ? appData.groups.find(g=>g.id==chatId).members.find(m=>m.id==recipientId)?.name : appData.contacts.find(c => c.id == recipientId)?.name;
                        wallet.transactions.push({ type: `转账给 ${targetName || '未知用户'}`, amount: -amount, timestamp: Date.now() });
                        sendMessage(chatId, chatType, { amount, remark, status: 'sent', recipientId: recipientId }, type);
                    } else if (type === 'redPacket') {
                        wallet.balance -= amount;
                        const targetName = chatType === 'group' ? '群聊' : (appData.contacts.find(c => c.id == recipientId)?.name || '未知用户');
                        wallet.transactions.push({ type: `发红包给 ${targetName}`, amount: -amount, timestamp: Date.now() });
                        sendMessage(chatId, chatType, { amount, remark, count: redPacketCount, claimed: [], total: redPacketCount }, type);
                    }
                }
                saveData();
                closeModal(modalId);
            };
        }
        
        function showVoiceInputModal(chatId, chatType) {
            const modalId = 'voice-input-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">模拟语音输入</div>
                    <div class="modal-input-group">
                        <textarea id="voice-text-input" class="modal-input" style="height: 100px;" placeholder="在此输入你想说的文本内容..."></textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="send-voice-btn">发送</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('send-voice-btn').onclick = () => {
                const text = document.getElementById('voice-text-input').value.trim();
                if (!text) return;
                const duration = Math.max(1, Math.ceil(text.length / 5));
                sendMessage(chatId, chatType, { text, duration }, 'voice');
                closeModal(modalId);
            };
        }

        function showCameraSimModal(chatId, chatType) {
            const desc = prompt("请输入您想通过“拍摄”发送的图片内容描述：");
            if (desc) {
                sendMessage(chatId, chatType, { description: desc }, 'camera-sim');
            }
        }

        function showLocationInputModal(chatId, chatType) {
            const location = prompt("请输入您想发送的位置信息 (350字以内)：", " ");
            if (location) {
                sendMessage(chatId, chatType, { location: location.substring(0, 350) }, 'location');
            }
        }

        function showStickerImportModal() {
            const modalId = 'sticker-import-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">导入表情包</div>
                    <div class="modal-input-group">
                        <label>表情包名称</label>
                        <input type="text" id="sticker-pack-name" class="modal-input" placeholder="例如：可爱猫猫">
                    </div>
                    <div class="modal-input-group">
                        <label>URL链接 (每行一个)</label>
                        <textarea id="sticker-urls" class="modal-input" style="height: 100px;" placeholder="https://.../cat1.png\nhttps://.../cat2.gif"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="import-sticker-btn">导入</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('import-sticker-btn').onclick = () => {
                const name = document.getElementById('sticker-pack-name').value.trim();
                const lines = document.getElementById('sticker-urls').value.trim().split('\n').filter(line => line);
                if (!name || lines.length === 0) {
                    alert('请输入表情包名称和至少一个URL');
                    return;
                }
                const newPack = {
                    name: name,
                    stickers: lines.map(line => ({ url: line.trim() }))
                };
                appData.stickers.packs.push(newPack);
                saveData(true);
                closeModal(modalId);
                renderStickerPage(document.getElementById('sticker-page'), true);
            };
        }

        // --- Core Logic ---
        function handleImageUpload(file, callback) {
            if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = e => callback(e.target.result);
            reader.readAsDataURL(file);
        }

        async function sendMessage(chatId, chatType, content, type, quotedMessageId = null) {
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            if (!chat) return;
            if (!chat.conversation) chat.conversation = [];
            
            const message = {
                id: Date.now(), sender: appData.user.id, type, content,
                timestamp: Date.now(), isRecalled: false
            };

            if (quotedMessageId) {
                const quotedMsg = chat.conversation.find(m => m.id == quotedMessageId);
                if (quotedMsg) {
                    message.quotedMessage = {
                        id: quotedMsg.id, sender: quotedMsg.sender,
                        content: quotedMsg.type === 'text' ? quotedMsg.content.content : `[${quotedMsg.type}]`
                    };
                }
            }
            
            chat.conversation.push(message);
            await saveData();
            renderMessages(chatId, chatType);
            
            // AI Reply Logic
            const shouldReply = ['text', 'image', 'camera-sim', 'location', 'voice', 'sticker', 'transfer', 'redPacket'].includes(type);
            if (chatType === 'individual' && shouldReply) {
                const replies = await getAiReply(chat.id);
                for (const reply of replies) {
                    const replyMsg = { id: Date.now() + Math.random(), sender: chat.id, type: 'text', content: { content: reply }, timestamp: Date.now() };
                    if (appData.stickers.packs.length > 0 && Math.random() < 0.2) { // 20% chance to send a sticker
                        const randomPack = appData.stickers.packs[Math.floor(Math.random() * appData.stickers.packs.length)];
                        const randomSticker = randomPack.stickers[Math.floor(Math.random() * randomPack.stickers.length)];
                        replyMsg.type = 'sticker';
                        replyMsg.content = { url: randomSticker.url };
                    }
                    chat.conversation.push(replyMsg);
                }
                await saveData();
                renderMessages(chatId, chatType);
            } else if (chatType === 'group' && shouldReply) {
                for (const member of chat.members) {
                    if (member.id !== appData.user.id && Math.random() < 0.3) { // 30% chance for each AI member to reply
                        const replies = await getAiReply(member.id, null, chat.id);
                        for (const reply of replies) {
                            chat.conversation.push({ id: Date.now() + Math.random(), sender: member.id, type: 'text', content: { content: reply }, timestamp: Date.now() });
                        }
                        await saveData();
                        renderMessages(chatId, chatType);
                    }
                }
            }
        }

        function sendSticker(url) {
            if (appData.activeChat.id) {
                sendMessage(appData.activeChat.id, appData.activeChat.type, { url }, 'sticker');
                goBack();
            }
        }

        async function getAiReply(senderId, customPrompt = null, groupId = null) {
            const contact = appData.contacts.find(c => c.id == senderId);
            if (!contact) return ["(AI角色不存在)"];

            let chatHistory = [];
            if (groupId) {
                const group = appData.groups.find(g => g.id === groupId);
                if (group) chatHistory = group.conversation;
            } else {
                chatHistory = contact.conversation;
            }

            const relevantHistory = chatHistory
                .filter(m => m.type !== 'typing' && !m.isRecalled)
                .map(m => {
                    const role = m.sender === appData.user.id ? 'user' : 'assistant';
                    let contentText = '';
                    switch(m.type) {
                        case 'text': contentText = m.content.content; break;
                        case 'image': contentText = `[${m.sender === appData.user.id ? appData.user.name : contact.name}发送了一张图片: ${m.content.description}]`; break;
                        case 'camera-sim': contentText = `[${m.sender === appData.user.id ? appData.user.name : contact.name}发送了一张图片，内容是: ${m.content.description}]`; break;
                        case 'sticker': contentText = `[${m.sender === appData.user.id ? appData.user.name : contact.name}发送了一个表情]`; break;
                        case 'transfer': contentText = `[${m.sender === appData.user.id ? appData.user.name : contact.name}发起了转账，金额: ${m.content.amount}]`; break;
                        case 'redPacket': contentText = `[${m.sender === appData.user.id ? appData.user.name : contact.name}发了红包，金额: ${m.content.amount}]`; break;
                        default: contentText = `[${m.sender === appData.user.id ? appData.user.name : contact.name}发送了一个${m.type}]`; break;
                    }
                    return { role, content: contentText };
                })
                .slice(-50);

            const isOfflineMode = appData.settings.chatMode === 'offline';
            const worldbookPreset = appData.worldbooks.presets.map(p => p.content).join('\n');
            const systemPrompt = customPrompt || `${worldbookPreset}\n\n【你的角色设定】\n${contact.persona}\n\n【对话者'${appData.user.name}'的人设】\n${appData.user.persona}\n\n请严格根据你的角色设定，并结合世界书与对方人设，以角色的口吻和身份，自然地与用户对话。不要暴露你是AI或模型。${isOfflineMode ? '请生成一段8000-15000字的剧情描述。' : '每次回复请生成10到25条短消息，每条消息用换行分隔。'}。`;

            const messages = [
                { role: 'system', content: systemPrompt },
                ...relevantHistory
            ];
            
            try {
                const rawReply = await callApi(messages);
                if (isOfflineMode) return [rawReply];
                return rawReply.split('\n').filter(s => s.trim() !== '');
            } catch (error) {
                console.error("AI reply error:", error);
                return [`(抱歉，AI出错了: ${error.message})`];
            }
        }

        async function callApi(messages) {
            const { endpoint, key, model, provider, temperature, top_p } = appData.settings.api;
            if (!key || !model) {
                throw new Error("API设置未配置或不完整。请在设置中配置。");
            }
            
            const providerEndpoints = {
                'openai': 'https://api.openai.com/v1', 'claude': 'https://api.anthropic.com/v1', 'gemini': 'https://generativelanguage.googleapis.com/v1beta',
                'deepseek': 'https://api.deepseek.com/v1', 'openrouter': 'https://openrouter.ai/api/v1', 'grok': 'https://api.groq.com/openai/v1',
                'doubao': 'https://ark.cn-beijing.volces.com/api/v3', 'custom': endpoint, 'custom_gemini': endpoint
            };
            const finalEndpoint = providerEndpoints[provider] || endpoint;
            if (!finalEndpoint) throw new Error("无效的API供应商或未设置自定义端点。");

            const apiUrl = `${finalEndpoint.replace(/\/$/, "")}/chat/completions`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({ model, messages, temperature, top_p, stream: false })
            });

            if (!response.ok) {
                const errorText = await response.text();
                try {
                    const errorData = JSON.parse(errorText);
                    throw new Error(errorData.error.message || `API请求失败: ${response.status}`);
                } catch {
                    throw new Error(`API请求失败: ${response.status} - ${errorText}`);
                }
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        async function fetchModels() {
            const { endpoint, key, provider } = {
                endpoint: document.getElementById('api-endpoint').value.trim(),
                key: document.getElementById('api-key').value.trim(),
                provider: document.getElementById('api-provider').value
            };
            if (!key) { alert("请先填写API密钥。"); return; }

            const providerEndpoints = { 'openai': 'https://api.openai.com/v1', 'deepseek': 'https://api.deepseek.com/v1', 'openrouter': 'https://openrouter.ai/api/v1' };
            const finalEndpoint = providerEndpoints[provider] || endpoint;
            if (!finalEndpoint) { alert("请选择有效的供应商或填写自定义端点。"); return; }
            
            const modelsUrl = `${finalEndpoint.replace(/\/$/, "")}/models`;
            
            try {
                const response = await fetch(modelsUrl, { headers: { 'Authorization': `Bearer ${key}` } });
                if (!response.ok) throw new Error(`服务器返回 ${response.status}`);
                
                const data = await response.json();
                const models = data.data || data;
                
                if (!Array.isArray(models)) throw new Error("返回的模型列表格式不正确。");

                const modelListHtml = models.map(m => `<div class="list-item" onclick="selectApiModel('${m.id}')">${m.id}</div>`).join('');
                showModal('model-selection-modal', `<div class="modal-content"><div class="modal-title">选择模型</div><div class="list-view" style="max-height: 60vh; overflow-y: auto;">${modelListHtml}</div></div>`);

            } catch (error) {
                console.error("Fetch models error:", error);
                alert(`获取模型列表失败: ${error.message}`);
            }
        }

        function selectApiModel(modelId) {
            document.getElementById('api-model').value = modelId;
            closeModal('model-selection-modal');
        }
        
        function applyBeautifySettings() {
            const root = document.documentElement;
            const bubbleStyle = document.getElementById('user-bubble-style');
            const voiceBubbleStyle = document.getElementById('user-voice-bubble-style');
            const beautify = appData.settings.beautify;
            
            // Screen Size
            root.style.setProperty('--phone-width', `${beautify.screenWidth}px`);
            root.style.setProperty('--phone-height', `${beautify.screenHeight}px`);

            // Theme
            document.body.classList.toggle('dark-mode', beautify.theme === 'dark');

            // Phone Frame
            const frameStyles = {
                white: { color: '#E5E5E5', width: '10px', shadow: '0 10px 40px rgba(0,0,0,0.2)', highlight: 'transparent' },
                black: { color: '#111', width: '10px', shadow: '0 15px 50px rgba(0,0,0,0.3)', highlight: 'transparent' },
                'simple-white': { color: '#FFF', width: '10px', shadow: '0 10px 40px rgba(0,0,0,0.2)', highlight: '#111' },
                pink: { color: '#FFC0CB', width: '10px', shadow: '0 10px 40px rgba(255,192,203,0.3)', highlight: 'transparent' },
                transparent: { color: 'transparent', width: '0px', shadow: 'none', highlight: 'transparent' },
                stereo: { color: '#111', width: '10px', shadow: '0 25px 60px rgba(0,0,0,0.5), inset 0 0 15px rgba(255,255,255,0.05)', highlight: '#fff' }
            };
            const style = frameStyles[beautify.phoneFrame] || frameStyles.black;
            root.style.setProperty('--phone-border-color', style.color);
            root.style.setProperty('--phone-border-width', style.width);
            root.style.setProperty('--phone-shadow', style.shadow);
            root.style.setProperty('--phone-edge-highlight', style.highlight);

            // Chat Background
            root.style.setProperty('--chat-background-image', beautify.chatBackground ? `url(${beautify.chatBackground})` : 'none');

            // Font
            if (beautify.fontFile) {
                root.style.setProperty('--user-custom-font-src', `url(${beautify.fontFile})`);
                root.style.setProperty('--user-custom-font', 'UserCustomFont, sans-serif');
            } else if (beautify.fontUrl) {
                root.style.setProperty('--user-custom-font-src', `url(${beautify.fontUrl})`);
                root.style.setProperty('--user-custom-font', 'UserCustomFont, sans-serif');
            } else {
                root.style.setProperty('--user-custom-font-src', 'none');
                root.style.setProperty('--user-custom-font', '-apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif');
            }
            root.style.setProperty('--font-size-base', `${beautify.fontSize}px`);

            // Avatar Shape & Frames
            root.style.setProperty('--avatar-shape', beautify.avatarShape);
            root.style.setProperty('--user-avatar-frame', beautify.userAvatarFrame ? `url(${beautify.userAvatarFrame})` : 'none');
            root.style.setProperty('--char-avatar-frame', beautify.charAvatarFrame ? `url(${beautify.charAvatarFrame})` : 'none');
            
            // Bubble CSS
            bubbleStyle.innerHTML = beautify.bubbleCss || '';
            voiceBubbleStyle.innerHTML = beautify.voiceBubbleCss || '';
        }

        // --- Message Context Menu Logic ---
        function showMessageContextMenu(event, messageId, chatId, chatType) {
            const menu = document.getElementById('message-context-menu');
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            const message = chat.conversation.find(m => m.id == messageId);
            if (!message || message.type === 'typing') return;

            let itemsHtml = `<div class="context-menu-item" data-action="quote">引用</div>`;
            if (message.type === 'text' || message.type === 'voice') {
                itemsHtml += `<div class="context-menu-item" data-action="translate">翻译<div class="context-submenu">
                    <div class="context-menu-item" data-lang="en">英语</div><div class="context-menu-item" data-lang="ru">俄语</div>
                    <div class="context-menu-item" data-lang="ja">日语</div><div class="context-menu-item" data-lang="ko">韩语</div>
                    <div class="context-menu-item" data-lang="de">德语</div><div class="context-menu-item" data-lang="fr">法语</div>
                </div></div>`;
            }
            if (message.type === 'voice') {
                itemsHtml += `<div class="context-menu-item" data-action="voiceToText">转文字</div>`;
            }
            itemsHtml += `<div class="context-menu-item" data-action="forward">转发</div>`;
            itemsHtml += `<div class="context-menu-item" data-action="multi-select">多选</div>`;
            
            menu.innerHTML = itemsHtml;
            menu.style.display = 'block';
            
            const menuRect = menu.getBoundingClientRect();
            const bodyRect = document.body.getBoundingClientRect();
            let left = event.clientX;
            if (left + menuRect.width > bodyRect.width) left = event.clientX - menuRect.width;
            let top = event.clientY;
            if (top + menuRect.height > bodyRect.height) top = event.clientY - menuRect.height;
            
            menu.style.left = `${left}px`;
            menu.style.top = `${top}px`;

            const closeMenu = () => {
                menu.style.display = 'none';
                document.removeEventListener('click', closeMenu);
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 0);

            menu.onclick = (e) => {
                e.stopPropagation();
                const target = e.target;
                const action = target.dataset.action || target.parentElement.dataset.action;
                const lang = target.dataset.lang;
                if (action) {
                    handleMessageAction(action, messageId, chatId, chatType, { lang });
                    closeMenu();
                }
            };
        }

        function handleMessageAction(action, messageId, chatId, chatType, options = {}) {
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            const messageIndex = chat.conversation.findIndex(m => m.id == messageId);
            if (messageIndex === -1) return;
            const message = chat.conversation[messageIndex];

            switch(action) {
                case 'quote':
                    const input = document.getElementById('chat-input');
                    input.focus();
                    input.dataset.quotedMessageId = messageId;
                    input.placeholder = '以引用的形式回复...';
                    break;
                case 'voiceToText':
                    if (message.transcribedText) delete message.transcribedText;
                    else message.transcribedText = `[转文字] ${message.content.text}`;
                    break;
                case 'translate':
                    if (message.translatedText) delete message.translatedText;
                    else {
                        const originalText = message.type === 'text' ? message.content.content : message.content.text;
                        message.translatedText = `[翻译] ${originalText}`;
                    }
                    break;
                case 'forward': showForwardMessageModal([message.id], chatId, chatType); break;
                case 'multi-select': toggleMultiSelectMode(true, messageId); break;
            }
            saveData();
            renderMessages(chatId, chatType);
        }

        function showForwardMessageModal(messageIds, currentChatId, currentChatType) {
            const modalId = 'forward-message-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">转发给...</div>
                    <div class="list-view" style="max-height: 300px; overflow-y: auto; background: transparent;">
                        ${appData.contacts.map(c => `<div class="list-item" onclick="confirmForward('${c.id}', 'individual', [${messageIds}])"><img src="${c.avatar}" class="avatar"><div class="details"><span class="name">${c.remark || c.name}</span></div></div>`).join('')}
                        ${appData.groups.map(g => `<div class="list-item" onclick="confirmForward('${g.id}', 'group', [${messageIds}])"><img src="${g.avatar || 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg'}" class="avatar"><div class="details"><span class="name">${g.name}</span></div></div>`).join('')}
                    </div>
                </div>
            `;
            showModal(modalId, html);
        }

        function confirmForward(targetChatId, targetChatType, messageIds) {
            // Find the original chat to get the messages from
            let originalChat = appData.contacts.find(c => c.conversation && c.conversation.some(m => messageIds.includes(m.id))) || appData.groups.find(g => g.conversation && g.conversation.some(m => messageIds.includes(m.id)));
            if (!originalChat) {
                alert('找不到原始消息。');
                return;
            }

            const messagesToForward = originalChat.conversation.filter(m => messageIds.includes(m.id)).slice(0, 100);

            if (messagesToForward.length === 0) { alert('没有可转发的消息。'); return; }

            let targetChat = targetChatType === 'group' ? appData.groups.find(g => g.id == targetChatId) : appData.contacts.find(c => c.id == targetChatId);
            if (!targetChat) return;

            const forwardedMsg = {
                id: Date.now(), sender: appData.user.id, type: 'forward',
                content: { messages: messagesToForward.map(msg => ({ ...msg })) },
                timestamp: Date.now()
            };
            targetChat.conversation.push(forwardedMsg);
            saveData();
            alert('消息已转发！');
            closeModal('forward-message-modal');
        }

        // --- Moments Feature ---
        function renderMomentsPage(container) {
            container.innerHTML = `
                <div class="wechat-header" style="background: transparent; border: none; position: absolute; top: 0; left: 0; right: 0; z-index: 5;">
                    <div class="header-left header-back-btn" onclick="goBack()" style="color: white;"><i class="fas fa-chevron-left"></i></div>
                    <div class="header-right" onclick="showPage('create-moment-page', renderCreateMomentPage)" style="color: white;"><i class="fas fa-camera"></i></div>
                </div>
                <div class="content-area">
                    <div class="moments-header-bg" id="moments-bg" style="background-image: url('${appData.user.moments_bg}')">
                        <div class="moments-user-info">
                            <div class="name-avatar-wrapper">
                                <span class="name">${appData.user.name}</span>
                                <img src="${appData.user.avatar}" class="avatar">
                            </div>
                            <div class="moments-signature">${appData.user.signature}</div>
                        </div>
                    </div>
                    <div id="moments-feed"></div>
                </div>
            `;
            document.getElementById('moments-bg').onclick = () => document.getElementById('moments-bg-input').click();
            container.insertAdjacentHTML('beforeend', '<input type="file" id="moments-bg-input" class="file-input" accept="image/*">');
            document.getElementById('moments-bg-input').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    appData.user.moments_bg = dataUrl;
                    saveData();
                    renderMomentsPage(document.getElementById('moments-page'));
                });
            };
            renderMomentsFeed();
        }

        function renderMomentsFeed() {
            const feedContainer = document.getElementById('moments-feed');
            if (!feedContainer) return;
            let html = '';
            const sortedMoments = [...appData.moments].sort((a, b) => b.timestamp - a.timestamp);

            sortedMoments.forEach(post => {
                const author = post.authorId === appData.user.id ? appData.user : appData.contacts.find(c => c.id == post.authorId);
                if (!author) return;

                let mediaHtml = '';
                if (post.media && post.media.length > 0) {
                    mediaHtml = '<div class="post-media">';
                    post.media.forEach(m => {
                        if (m.type.startsWith('image')) mediaHtml += `<img src="${m.url}" alt="moment image">`;
                        else if (m.type.startsWith('video')) mediaHtml += `<video src="${m.url}" controls></video>`;
                        else if (m.type.startsWith('audio')) mediaHtml += `<audio src="${m.url}" controls></audio>`;
                    });
                    mediaHtml += '</div>';
                }

                const likesHtml = post.likes.length > 0 ? `
                    <div class="post-likes">
                        <i class="fas fa-heart"></i>
                        ${post.likes.map(likeId => {
                            const liker = likeId === appData.user.id ? appData.user : appData.contacts.find(c => c.id == likeId);
                            return liker ? (liker.remark || liker.name) : '';
                        }).filter(Boolean).join(', ')}
                    </div>` : '';

                const commentsHtml = post.comments.length > 0 ? `
                    <div class="post-comments">
                        ${post.comments.map(comment => {
                            const commenter = comment.authorId === appData.user.id ? appData.user : appData.contacts.find(c => c.id == comment.authorId);
                            const commenterName = commenter ? (commenter.remark || commenter.name) : '未知用户';
                            return `<div class="moment-comment"><span class="comment-author" onclick="replyToComment(${post.id}, ${comment.authorId}, '${commenterName}')">${commenterName}:</span> ${comment.text}</div>`;
                        }).join('')}
                    </div>` : '';

                html += `
                    <div class="moment-post" data-post-id="${post.id}">
                        <img src="${author.avatar}" class="avatar">
                        <div class="post-content">
                            <div class="post-author">${author.remark || author.name}</div>
                            <div class="post-text">${post.text}</div>
                            ${mediaHtml}
                            <div class="post-meta">
                                <span class="post-time">${new Date(post.timestamp).toLocaleString()}</span>
                                <span class="post-actions">
                                    <i class="fas fa-thumbs-up" onclick="toggleMomentLike(${post.id}, '${appData.user.id}')"></i>
                                    <i class="fas fa-comment-dots" onclick="showMomentCommentInput(${post.id})"></i>
                                </span>
                            </div>
                            <div class="post-interactions">${likesHtml}${commentsHtml}</div>
                            <div id="comment-input-${post.id}" style="display:none; margin-top: 10px;">
                                <input type="text" placeholder="发表评论..." style="width: calc(100% - 60px); padding: 8px; border-radius: 4px; border: 1px solid #eee;">
                                <button onclick="addMomentComment(${post.id})" style="padding: 8px 12px; background: var(--wechat-green); color: white; border: none; border-radius: 4px;">发送</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            feedContainer.innerHTML = html;

            document.querySelectorAll('.moment-post').forEach(postEl => {
                let pressTimer;
                const startPress = (e) => {
                    pressTimer = setTimeout(() => {
                        e.preventDefault();
                        showMomentContextMenu(e, parseInt(postEl.dataset.postId));
                    }, 500);
                };
                const endPress = () => clearTimeout(pressTimer);
                postEl.addEventListener('mousedown', startPress);
                postEl.addEventListener('mouseup', endPress);
                postEl.addEventListener('mouseleave', endPress);
                postEl.addEventListener('touchstart', startPress);
                postEl.addEventListener('touchend', endPress);
            });
        }

        function showMomentContextMenu(event, postId) {
            const menu = document.getElementById('message-context-menu');
            menu.innerHTML = `<div class="context-menu-item" onclick="deleteMoment(${postId})">删除</div>`;
            menu.style.display = 'block';
            menu.style.left = `${event.clientX}px`;
            menu.style.top = `${event.clientY}px`;
            const closeMenu = () => {
                menu.style.display = 'none';
                document.removeEventListener('click', closeMenu);
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 0);
        }

        function deleteMoment(postId) {
            if (confirm('确定要删除这条动态吗？')) {
                appData.moments = appData.moments.filter(p => p.id !== postId);
                saveData();
                renderMomentsFeed();
            }
        }

        function replyToComment(postId, authorId, authorName) {
            if (authorId === appData.user.id) return; // Can't reply to self
            const inputDiv = document.getElementById(`comment-input-${postId}`);
            const input = inputDiv.querySelector('input');
            inputDiv.style.display = 'block';
            input.value = `回复 ${authorName}: `;
            input.focus();
        }

        function showMomentCommentInput(postId) {
            const inputDiv = document.getElementById(`comment-input-${postId}`);
            if (inputDiv) {
                inputDiv.style.display = inputDiv.style.display === 'none' ? 'block' : 'none';
                if (inputDiv.style.display === 'block') {
                    inputDiv.querySelector('input').focus();
                }
            }
        }

        async function addMomentComment(postId) {
            const input = document.querySelector(`#comment-input-${postId} input`);
            const commentText = input.value.trim();
            if (!commentText) return;

            const post = appData.moments.find(p => p.id === postId);
            if (post) {
                post.comments.push({ authorId: appData.user.id, text: commentText, timestamp: Date.now() });
                await saveData();
                renderMomentsFeed();

                // AI reply to comment
                const author = appData.contacts.find(c => c.id == post.authorId);
                if (author && author.id !== appData.user.id) {
                    const prompt = `你的朋友'${appData.user.name}'刚刚在你的朋友圈下评论了：“${commentText}”。请你根据自己的角色设定(${author.persona})，对此进行回复。`;
                    const replies = await getAiReply(author.id, prompt);
                    const updatedPost = appData.moments.find(p => p.id === postId);
                    if (updatedPost) {
                        for (const reply of replies) {
                            updatedPost.comments.push({ authorId: author.id, text: reply, timestamp: Date.now() });
                        }
                        await saveData();
                        renderMomentsFeed();
                    }
                }
            }
        }

        function toggleMomentLike(postId, userId) {
            const post = appData.moments.find(p => p.id === postId);
            if (post) {
                const index = post.likes.indexOf(userId);
                if (index > -1) post.likes.splice(index, 1);
                else post.likes.push(userId);
                saveData();
                renderMomentsFeed();
            }
        }

        function renderCreateMomentPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()">取消</div>
                    <span class="header-title">发表朋友圈</span>
                    <div class="header-right" style="font-size: 16px; color: white; background: var(--wechat-green); padding: 5px 12px; border-radius: 4px;" id="post-moment-btn">发表</div>
                </div>
                <div class="content-area">
                    <textarea id="moment-text-input" maxlength="10000" placeholder="这一刻的想法..." style="width: 100%; height: 200px; border: none; padding: 15px; box-sizing: border-box; font-size: 16px; resize: none; background: transparent; color: var(--wechat-text-primary);"></textarea>
                    <div style="padding: 15px;">
                        <button onclick="document.getElementById('moment-media-input').click()" class="form-btn" style="margin-top: 0; margin-bottom: 10px; background: #f0f0f0; color: #333;">选择图片/视频/音频</button>
                        <input type="file" id="moment-media-input" class="file-input" accept="image/*,video/*,audio/*" multiple>
                        <div id="moment-media-preview" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
                    </div>
                </div>
            `;

            const mediaInput = document.getElementById('moment-media-input');
            const mediaPreview = document.getElementById('moment-media-preview');
            let selectedMedia = [];

            mediaInput.onchange = (e) => {
                selectedMedia = [];
                mediaPreview.innerHTML = '';
                Array.from(e.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        selectedMedia.push({ type: file.type, url: event.target.result });
                        if (file.type.startsWith('image')) mediaPreview.innerHTML += `<img src="${event.target.result}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">`;
                        else if (file.type.startsWith('video')) mediaPreview.innerHTML += `<video src="${event.target.result}" controls style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;"></video>`;
                        else if (file.type.startsWith('audio')) mediaPreview.innerHTML += `<audio src="${event.target.result}" controls style="width: 100%;"></audio>`;
                    };
                    reader.readAsDataURL(file);
                });
            };

            document.getElementById('post-moment-btn').onclick = async () => {
                const text = document.getElementById('moment-text-input').value.trim();
                if (!text && selectedMedia.length === 0) { alert('内容或媒体不能为空'); return; }

                const newPost = {
                    id: Date.now(), authorId: appData.user.id, text, media: selectedMedia,
                    timestamp: Date.now(), likes: [], comments: []
                };

                appData.moments.push(newPost);
                await saveData();
                goBack();

                for (const contact of appData.contacts) {
                    const prompt = `你的朋友'${appData.user.name}'刚刚发了一条朋友圈，内容是：“${text}”。请你根据自己的角色设定(${contact.persona})，对此进行评论或点赞。如果评论，请直接输出评论内容；如果只想点赞，请输出“[点赞]”`;
                    const reactions = await getAiReply(contact.id, prompt);
                    const post = appData.moments.find(p => p.id === newPost.id);
                    if (post) {
                        for (const reaction of reactions) {
                            if (reaction.includes('[点赞]')) {
                                if (!post.likes.includes(contact.id)) post.likes.push(contact.id);
                            }
                            const commentText = reaction.replace('[点赞]', '').trim();
                            if (commentText) post.comments.push({ authorId: contact.id, text: commentText, timestamp: Date.now() });
                        }
                        await saveData();
                        if (document.getElementById('moments-page').classList.contains('active')) renderMomentsFeed();
                    }
                }
            };
        }

        // --- Char Moment Posting Logic ---
        async function checkAndPostCharMoments() {
            const now = Date.now();
            const intervalMap = { 'low': 3 * 24 * 3600000, 'default': 1 * 24 * 3600000, 'high': 6 * 3600000 };
            const interval = intervalMap[appData.settings.charMomentFrequency] || intervalMap.default;

            for (const contact of appData.contacts) {
                if (now - (contact.lastMomentPostTime || 0) > interval) {
                    const prompt = `请你根据自己的角色设定(${contact.persona})和心情，生成一条朋友圈动态，内容可以是碎碎念、生活感悟、分享日常等，字数在50-200字之间。`;
                    const momentText = (await getAiReply(contact.id, prompt))[0];

                    if (momentText && !momentText.startsWith('(')) {
                        const newPost = {
                            id: Date.now(), authorId: contact.id, text: momentText, media: [],
                            timestamp: Date.now(), likes: [], comments: []
                        };
                        appData.moments.push(newPost);
                        contact.lastMomentPostTime = now;
                        await saveData();
                        if (document.getElementById('moments-page').classList.contains('active')) renderMomentsFeed();
                    }
                }
            }
        }
        setInterval(checkAndPostCharMoments, 3600000);

        // --- Chat Settings ---
        function renderChatSettingsPage(container, contactId) {
            const contact = appData.contacts.find(c => c.id == contactId);
            if (!contact) { goBack(); return; }

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">聊天设置</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item">
                        <div class="details"><span class="name">置顶聊天</span></div>
                        <label class="switch"><input type="checkbox" id="pin-toggle" ${contact.isPinned ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="list-item">
                        <div class="details"><span class="name">设为星标朋友</span></div>
                        <label class="switch"><input type="checkbox" id="star-toggle" ${contact.isStarred ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="setContactRemark(${contactId})">
                        <div class="details"><span class="name">设置备注</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="clearChatHistory(${contactId})">
                        <div class="details"><span class="name">清空聊天记录</span></div>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="blockContact(${contactId})">
                        <div class="details"><span class="name" style="color: var(--wechat-red);">拉黑</span></div>
                    </div>
                    <div class="list-item" onclick="deleteContact(${contactId})">
                        <div class="details"><span class="name" style="color: var(--wechat-red);">删除好友</span></div>
                    </div>
                </div>
            `;

            document.getElementById('pin-toggle').onchange = (e) => togglePin(contactId, e.target.checked);
            document.getElementById('star-toggle').onchange = (e) => toggleStar(contactId, e.target.checked);
        }

        function clearChatHistory(contactId) {
            if (confirm('确定要清空与该好友的聊天记录吗？此操作不可恢复。')) {
                const contact = appData.contacts.find(c => c.id == contactId);
                if (contact) {
                    contact.conversation = [];
                    saveData(true, () => {
                        if (appData.activeChat.id == contactId) {
                            renderMessages(contactId, 'individual');
                        }
                    });
                }
            }
        }

        function togglePin(contactId, isPinned) {
            const contact = appData.contacts.find(c => c.id == contactId);
            contact.isPinned = isPinned;
            saveData();
        }

        function toggleStar(contactId, isStarred) {
            const contact = appData.contacts.find(c => c.id == contactId);
            contact.isStarred = isStarred;
            saveData();
        }

        function setContactRemark(contactId) {
            const contact = appData.contacts.find(c => c.id == contactId);
            const newRemark = prompt('请输入新的备注名：', contact.remark || '');
            if (newRemark !== null) {
                contact.remark = newRemark.trim();
                saveData();
                renderChatSettingsPage(document.getElementById('chat-settings-page'), contactId);
                renderConversationPage(document.getElementById('conversation-page'), contactId, 'individual');
            }
        }

        function blockContact(contactId) {
            if (confirm('拉黑后将不再收到对方的消息，确定要拉黑吗？')) {
                if (!appData.settings.blacklist.includes(contactId)) {
                    appData.settings.blacklist.push(contactId);
                    saveData(true, () => { goBack(); goBack(); });
                }
            }
        }

        function deleteContact(contactId) {
            if (confirm('删除好友将同时删除与该好友的聊天记录，确定要删除吗？')) {
                appData.contacts = appData.contacts.filter(c => c.id != contactId);
                saveData(true, () => { goBack(); goBack(); });
            }
        }

        function renderBlacklistPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">黑名单</span>
                </div>
                <div class="content-area" id="blacklist-container"></div>
            `;
            renderBlacklist();
        }

        function renderBlacklist() {
            const container = document.getElementById('blacklist-container');
            let html = '<div class="list-view">';
            if (appData.settings.blacklist.length === 0) {
                html += '<div style="text-align:center; padding: 50px; color: var(--wechat-text-secondary);">黑名单为空</div>';
            } else {
                appData.settings.blacklist.forEach(contactId => {
                    const contact = appData.contacts.find(c => c.id == contactId);
                    if (contact) {
                        html += `
                            <div class="list-item" onclick="unblockContact(${contactId})">
                                <img src="${contact.avatar}" class="avatar">
                                <div class="details"><span class="name">${contact.remark || contact.name}</span></div>
                                <div class="info" style="color: var(--wechat-blue);">移除</div>
                            </div>
                        `;
                    }
                });
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function unblockContact(contactId) {
            appData.settings.blacklist = appData.settings.blacklist.filter(id => id != contactId);
            saveData();
            renderBlacklist();
        }

        // --- Data Management ---
        function renderDataManagementPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>设置</span></div>
                    <span class="header-title">数据管理</span>
                </div>
                <div class="content-area" style="padding: 20px;">
                    <button class="form-btn" id="export-data-btn">备份数据到文件</button>
                    <button class="form-btn" style="background-color: #aaa; margin-top: 10px;" onclick="document.getElementById('import-data-input').click()">从文件恢复数据</button>
                    <input type="file" id="import-data-input" class="file-input" accept=".json">
                </div>
            `;
            document.getElementById('export-data-btn').onclick = exportData;
            document.getElementById('import-data-input').onchange = importData;
        }

        async function exportData() {
            const allData = await dataManager.exportAllData();
            const dataStr = JSON.stringify(allData);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wechat_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!confirm('恢复数据将覆盖当前所有内容，确定要继续吗？')) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.appData && importedData.appData.user && importedData.appData.contacts) {
                        await dataManager.importFromBackup(importedData);
                        alert('数据恢复成功！应用将重新加载。');
                        location.reload();
                    } else {
                        alert('文件格式不正确或数据结构不完整，恢复失败。');
                    }
                } catch (err) {
                    alert('解析文件失败：' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        function handleBubbleClick(type, msgId, chatId, chatType) {
            let chat = chatType === 'group' ? appData.groups.find(g => g.id == chatId) : appData.contacts.find(c => c.id == chatId);
            const message = chat.conversation.find(m => m.id == msgId);
            if (!message) return;

            if (type === 'camera-sim') {
                alert(`图片内容：\n\n${message.content.description}`);
            } else if (type === 'redPacket' && message.sender !== appData.user.id) {
                if (message.content.claimed.includes(appData.user.id)) { alert('你已经领取过该红包了。'); return; }
                if (message.content.claimed.length >= message.content.count) { alert('该红包已被领完。'); return; }

                if (confirm('是否领取红包？')) {
                    const amountPerPerson = message.content.amount / message.content.count;
                    appData.user.wallet.balance += amountPerPerson;
                    const senderName = chatType === 'group' ? (chat.members.find(m => m.id === message.sender)?.name || '群成员') : (chat.remark || chat.name);
                    appData.user.wallet.transactions.push({ type: `收到${senderName}的红包`, amount: amountPerPerson, timestamp: Date.now() });
                    
                    message.content.claimed.push(appData.user.id);
                    
                    const systemMsg = {
                        id: Date.now(), type: 'system',
                        content: { content: `${appData.user.name} 领取了 ${senderName} 的红包` },
                        timestamp: Date.now()
                    };
                    chat.conversation.push(systemMsg);
                    saveData();
                    renderMessages(chatId, chatType);
                }
            } else if (type === 'transfer' && message.sender !== appData.user.id && message.content.status === 'sent') {
                const modalId = 'transfer-receive-modal';
                const html = `
                    <div class="modal-content">
                        <div class="modal-title">收到转账</div>
                        <p style="text-align: center; font-size: 24px; font-weight: bold;">¥${parseFloat(message.content.amount).toFixed(2)}</p>
                        <p style="text-align: center; color: #888;">${message.content.remark}</p>
                        <div class="modal-actions">
                            <button class="modal-btn" id="transfer-return-btn">退回</button>
                            <button class="modal-btn primary" id="transfer-claim-btn">收款</button>
                        </div>
                    </div>
                `;
                showModal(modalId, html);

                document.getElementById('transfer-claim-btn').onclick = () => {
                    const amount = parseFloat(message.content.amount);
                    appData.user.wallet.balance += amount;
                    const senderName = chatType === 'group' ? (chat.members.find(m => m.id === message.sender)?.name || '群成员') : (chat.remark || chat.name);
                    appData.user.wallet.transactions.push({ type: `收到${senderName}的转账`, amount: amount, timestamp: Date.now() });
                    message.content.status = 'claimed';
                    
                    const systemMsg = { id: Date.now(), type: 'system', content: { content: `${appData.user.name} 已收款` }, timestamp: Date.now() };
                    chat.conversation.push(systemMsg);
                    saveData();
                    renderMessages(chatId, chatType);
                    closeModal(modalId);
                };

                document.getElementById('transfer-return-btn').onclick = () => {
                    message.content.status = 'returned';
                    const systemMsg = { id: Date.now(), type: 'system', content: { content: `${appData.user.name} 已退回转账` }, timestamp: Date.now() };
                    chat.conversation.push(systemMsg);
                    saveData();
                    renderMessages(chatId, chatType);
                    closeModal(modalId);
                };
            } else if (type === 'forward') {
                const modalId = 'view-forwarded-messages-modal';
                const messagesHtml = message.content.messages.map(msg => {
                    const sender = msg.sender === appData.user.id ? appData.user : (appData.contacts.find(c => c.id == msg.sender) || {name: '未知'});
                    let content = '';
                    switch(msg.type) {
                        case 'text': content = msg.content.content; break;
                        default: content = `[${msg.type}]`; break;
                    }
                    return `<p><strong>${sender.name}:</strong> ${content}</p>`;
                }).join('');

                const html = `
                    <div class="modal-content">
                        <div class="modal-title">聊天记录</div>
                        <div style="max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #eee; border-radius: 8px;">${messagesHtml}</div>
                        <button class="modal-btn primary" onclick="closeModal('${modalId}')" style="margin-top: 15px;">关闭</button>
                    </div>
                `;
                showModal(modalId, html);
            }
        }

        // --- Group Chat Functions ---
        function renderCreateGroupChatPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">发起群聊</span>
                    <div class="header-right" style="font-size: 16px;" id="create-group-btn">创建</div>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>群聊名称</label>
                        <input type="text" id="group-name-input" placeholder="请输入群聊名称">
                    </div>
                    <div class="form-group">
                        <label>群头像</label>
                        <img src="https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg" class="avatar-upload-preview" id="group-avatar-preview" onclick="document.getElementById('group-avatar-input').click()">
                        <input type="file" id="group-avatar-input" class="file-input" accept="image/jpeg, image/gif">
                    </div>
                    <div class="list-divider"></div>
                    <div class="selected-contacts-preview" id="selected-group-members-preview">
                        <img src="${appData.user.avatar}" class="avatar">
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-view contact-selection-list" id="group-member-selection"></div>
                </div>
            `;

            const selectionContainer = document.getElementById('group-member-selection');
            selectionContainer.innerHTML = appData.contacts.map(contact => `
                <div class="list-item">
                    <input type="checkbox" data-member-id="${contact.id}" data-member-avatar="${contact.avatar}">
                    <img src="${contact.avatar}" class="avatar">
                    <div class="details"><span class="name">${contact.name}</span></div>
                </div>
            `).join('');

            const selectedMembersPreview = document.getElementById('selected-group-members-preview');
            let selectedMemberIds = [];
            let groupAvatar = 'https://img.js.design/assets/img/65a881fa383e6a42242a3f33.jpg';

            document.getElementById('group-avatar-input').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    document.getElementById('group-avatar-preview').src = dataUrl;
                    groupAvatar = dataUrl;
                });
            };

            selectionContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.onchange = (e) => {
                    const memberId = parseInt(e.target.dataset.memberId);
                    const memberAvatar = e.target.dataset.memberAvatar;
                    if (e.target.checked) {
                        selectedMemberIds.push(memberId);
                        selectedMembersPreview.innerHTML += `<img src="${memberAvatar}" class="avatar" data-preview-id="${memberId}">`;
                    } else {
                        selectedMemberIds = selectedMemberIds.filter(id => id !== memberId);
                        document.querySelector(`img[data-preview-id="${memberId}"]`).remove();
                    }
                };
            });

            document.getElementById('create-group-btn').onclick = () => {
                const groupName = document.getElementById('group-name-input').value.trim();
                if (!groupName) { alert('群聊名称不能为空'); return; }
                if (selectedMemberIds.length < 1) { alert('请至少选择一个好友'); return; }

                const newGroup = {
                    id: Date.now(), name: groupName, avatar: groupAvatar,
                    members: [appData.user, ...appData.contacts.filter(c => selectedMemberIds.includes(c.id))],
                    conversation: [], adminIds: [appData.user.id], announcement: '',
                    isPinned: false, isStarred: false, mutedMembers: {}
                };
                appData.groups.push(newGroup);
                saveData(true, () => showPage('conversation-page', renderConversationPage, newGroup.id, 'group'));
            };
        }

        function renderGroupChatSettingsPage(container, groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            if (!group) { goBack(); return; }
            const isUserAdmin = group.adminIds.includes(appData.user.id);

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">群聊设置</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="editGroupName(${groupId})">
                        <div class="details"><span class="name">群聊名称</span></div>
                        <span class="info">${group.name}</span><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="editGroupAvatar(${groupId})">
                        <div class="details"><span class="name">群头像</span></div>
                        <img src="${group.avatar}" class="avatar" style="width: 40px; height: 40px;">
                        <i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showPage('group-member-management-page', renderGroupMemberManagementPage, ${groupId})">
                        <div class="details"><span class="name">群成员 (${group.members.length})</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    ${isUserAdmin ? `
                    <div class="list-item" onclick="editGroupAnnouncement(${groupId})">
                        <div class="details"><span class="name">群公告</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                    <div class="list-item" onclick="showMuteSettingsModal(${groupId})">
                        <div class="details"><span class="name">设置禁言</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>` : ''}
                    <div class="list-divider"></div>
                    <div class="list-item">
                        <div class="details"><span class="name">置顶聊天</span></div>
                        <label class="switch"><input type="checkbox" id="group-pin-toggle" ${group.isPinned ? 'checked' : ''}><span class="slider"></span></label>
                    </div>
                    <div class="list-divider"></div>
                    <button class="form-btn" style="background-color: #E64340; margin: 20px;" onclick="leaveGroupChat(${groupId})">退出群聊</button>
                </div>
            `;

            document.getElementById('group-pin-toggle').onchange = (e) => {
                group.isPinned = e.target.checked;
                saveData();
            };
        }

        function showMuteSettingsModal(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const modalId = 'mute-settings-modal';
            const membersHtml = group.members.map(member => {
                if (member.id === appData.user.id) return '';
                const isMuted = group.mutedMembers[member.id] && group.mutedMembers[member.id] > Date.now();
                const muteUntil = isMuted ? new Date(group.mutedMembers[member.id]).toLocaleString() : '未禁言';
                return `
                    <div class="list-item">
                        <img src="${member.avatar}" class="avatar">
                        <div class="details"><span class="name">${member.name}</span><p class="subtext">禁言至: ${muteUntil}</p></div>
                        <div class="member-actions">
                            ${isMuted ? `<button onclick="unmuteMember(${groupId}, '${member.id}'); closeModal('${modalId}')">解除</button>` : `<button onclick="showMuteDurationModal(${groupId}, '${member.id}'); closeModal('${modalId}')">禁言</button>`}
                        </div>
                    </div>
                `;
            }).join('');

            const html = `
                <div class="modal-content" style="max-width: 90%; width: 350px;">
                    <div class="modal-title">禁言设置</div>
                    <div class="list-view" style="max-height: 60vh; overflow-y: auto; background: transparent;">
                        <div class="list-item">
                            <div class="details"><span class="name">全体禁言</span></div>
                            <label class="switch"><input type="checkbox" id="mute-all-toggle" ${group.mutedMembers['all'] ? 'checked' : ''}><span class="slider"></span></label>
                        </div>
                        ${membersHtml}
                    </div>
                </div>
            `;
            showModal(modalId, html);

            document.getElementById('mute-all-toggle').onchange = (e) => {
                if (e.target.checked) group.mutedMembers['all'] = Date.now() + (100 * 365 * 24 * 3600000);
                else delete group.mutedMembers['all'];
                saveData();
                closeModal(modalId);
            };
        }

        function showMuteDurationModal(groupId, memberId) {
            const modalId = 'mute-duration-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">禁言时长</div>
                    <div class="modal-input-group">
                        <label>天</label><input type="number" id="mute-days" value="0" min="0">
                        <label>时</label><input type="number" id="mute-hours" value="0" min="0" max="23">
                        <label>分</label><input type="number" id="mute-minutes" value="0" min="0" max="59">
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal('${modalId}')">取消</button>
                        <button class="modal-btn primary" id="confirm-mute-btn">确认</button>
                    </div>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('confirm-mute-btn').onclick = () => {
                const days = parseInt(document.getElementById('mute-days').value) || 0;
                const hours = parseInt(document.getElementById('mute-hours').value) || 0;
                const minutes = parseInt(document.getElementById('mute-minutes').value) || 0;
                const duration = (days * 24 * 3600 + hours * 3600 + minutes * 60) * 1000;
                if (duration <= 0) { alert('禁言时长必须大于0'); return; }
                
                const group = appData.groups.find(g => g.id == groupId);
                group.mutedMembers[memberId] = Date.now() + duration;
                saveData();
                closeModal(modalId);
            };
        }

        function unmuteMember(groupId, memberId) {
            const group = appData.groups.find(g => g.id == groupId);
            delete group.mutedMembers[memberId];
            saveData();
        }

        function editGroupName(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const newName = prompt('请输入新的群聊名称：', group.name);
            if (newName && newName.trim()) {
                group.name = newName.trim();
                saveData();
                renderGroupChatSettingsPage(document.getElementById('group-chat-settings-page'), groupId);
                renderConversationPage(document.getElementById('conversation-page'), groupId, 'group');
            }
        }

        function editGroupAvatar(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const modalId = 'edit-group-avatar-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">更换群头像</div>
                    <img src="${group.avatar}" class="avatar-upload-preview" id="group-avatar-preview-modal" onclick="document.getElementById('group-avatar-input-modal').click()">
                    <input type="file" id="group-avatar-input-modal" class="file-input" accept="image/jpeg, image/gif">
                    <button class="modal-btn primary" id="save-group-avatar-btn" style="margin-top: 15px;">保存</button>
                </div>
            `;
            showModal(modalId, html);

            document.getElementById('group-avatar-input-modal').onchange = e => {
                handleImageUpload(e.target.files[0], dataUrl => {
                    document.getElementById('group-avatar-preview-modal').src = dataUrl;
                });
            };
            document.getElementById('save-group-avatar-btn').onclick = () => {
                group.avatar = document.getElementById('group-avatar-preview-modal').src;
                saveData(true);
                renderGroupChatSettingsPage(document.getElementById('group-chat-settings-page'), groupId);
                closeModal(modalId);
            };
        }

        function editGroupAnnouncement(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const newAnnouncement = prompt('请输入群公告 (上限5000字)：', group.announcement);
            if (newAnnouncement !== null) {
                group.announcement = newAnnouncement.substring(0, 5000);
                saveData();
                const systemMsg = { id: Date.now(), type: 'system', content: { content: `群公告: ${group.announcement}` }, timestamp: Date.now() };
                group.conversation.push(systemMsg);
                renderMessages(groupId, 'group');
            }
        }

        function renderGroupMemberManagementPage(container, groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            if (!group) { goBack(); return; }
            const isUserAdmin = group.adminIds.includes(appData.user.id);

            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">群成员管理</span>
                    ${isUserAdmin ? `<div class="header-right" onclick="showAddGroupMembersModal(${groupId})"><i class="fas fa-user-plus"></i></div>` : ''}
                </div>
                <div class="content-area group-member-list list-view" id="group-members-list"></div>
            `;
            renderGroupMembersList(groupId);
        }

        function renderGroupMembersList(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const listContainer = document.getElementById('group-members-list');
            const isUserAdmin = group.adminIds.includes(appData.user.id);

            listContainer.innerHTML = group.members.map(member => {
                const isMemberAdmin = group.adminIds.includes(member.id);
                return `
                    <div class="list-item">
                        <img src="${member.avatar}" class="avatar">
                        <div class="details"><span class="name">${member.name} ${isMemberAdmin ? '(管理员)' : ''}</span></div>
                        <div class="member-actions">
                            ${isUserAdmin && member.id !== appData.user.id ? `
                                <button onclick="toggleGroupAdmin(${groupId}, '${member.id}')">${isMemberAdmin ? '取消' : '设为管理员'}</button>
                                <button onclick="removeGroupMember(${groupId}, '${member.id}')">移出</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddGroupMembersModal(groupId) {
            const group = appData.groups.find(g => g.id == groupId);
            const existingMemberIds = group.members.map(m => m.id);
            const availableContacts = appData.contacts.filter(c => !existingMemberIds.includes(c.id));

            const modalId = 'add-group-members-modal';
            let html = `
                <div class="modal-content">
                    <div class="modal-title">添加群成员</div>
                    <div class="list-view contact-selection-list" id="add-members-selection">
            `;
            if (availableContacts.length === 0) {
                html += '<div style="text-align:center; padding: 20px;">暂无更多好友可添加</div>';
            } else {
                html += availableContacts.map(contact => `
                    <div class="list-item">
                        <input type="checkbox" data-member-id="${contact.id}">
                        <img src="${contact.avatar}" class="avatar">
                        <div class="details"><span class="name">${contact.name}</span></div>
                    </div>
                `).join('');
            }
            html += `</div><button class="modal-btn primary" id="confirm-add-members-btn" style="margin-top: 15px;">添加</button></div>`;
            showModal(modalId, html);

            document.getElementById('confirm-add-members-btn').onclick = () => {
                const selectedCheckboxes = document.querySelectorAll('#add-members-selection input:checked');
                const newMemberIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.memberId));
                const newMembers = appData.contacts.filter(c => newMemberIds.includes(c.id));
                group.members.push(...newMembers);
                saveData();
                renderGroupMembersList(groupId);
                closeModal(modalId);
            };
        }

        function toggleGroupAdmin(groupId, memberId) {
            const group = appData.groups.find(g => g.id == groupId);
            const index = group.adminIds.indexOf(memberId);
            if (index > -1) group.adminIds.splice(index, 1);
            else group.adminIds.push(memberId);
            saveData();
            renderGroupMembersList(groupId);
        }

        function removeGroupMember(groupId, memberId) {
            if (confirm('确定要将该成员移出群聊吗？')) {
                const group = appData.groups.find(g => g.id == groupId);
                group.members = group.members.filter(m => m.id != memberId);
                group.adminIds = group.adminIds.filter(id => id != memberId);
                saveData();
                renderGroupMembersList(groupId);
            }
        }

        function leaveGroupChat(groupId) {
            if (confirm('确定要退出群聊吗？')) {
                appData.groups = appData.groups.filter(g => g.id != groupId);
                saveData(true, () => { goBack(); goBack(); });
            }
        }

        // --- Music Player ---
        let audioPlayer = new Audio();
        audioPlayer.onended = () => playNextSong();

        function renderMusicLibraryPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
<span class="header-title">音乐库</span>
                    <div class="header-right" onclick="showPage('music-settings-page', renderMusicSettingsPage)"><i class="fas fa-cog"></i></div>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-view">
                        <div class="list-item" onclick="showAddMusicModal()">
                            <div class="details"><span class="name">导入新音乐</span></div><i class="fas fa-plus chevron"></i>
                        </div>
                        <div class="list-item" onclick="renderMusicLists('favorites')">
                            <div class="details"><span class="name">收藏列表</span></div><i class="fas fa-chevron-right chevron"></i>
                        </div>
                    </div>
                    <div class="list-divider"></div>
                    <div class="list-view" id="music-library-list"></div>
                </div>
            `;
            renderMusicLists('all');
        }

        function renderMusicLists(filter = 'all') {
            const libList = document.getElementById('music-library-list');
            let songsToShow;
            if (filter === 'favorites') {
                songsToShow = appData.music.library.filter(s => appData.music.favorites.includes(s.id));
            } else {
                songsToShow = appData.music.library;
            }
            
            libList.innerHTML = songsToShow.map(song => `
                <div class="list-item" onclick="playSong(${song.id})">
                    <div class="details"><span class="name">${song.title}</span><p class="subtext">${song.artist}</p></div>
                    <i class="fas fa-heart" style="color: ${appData.music.favorites.includes(song.id) ? 'var(--wechat-red)' : '#ccc'};" onclick="toggleFavorite(${song.id}, event)"></i>
                </div>
            `).join('') || `<div style="text-align:center; padding: 50px; color: var(--wechat-text-secondary);">暂无音乐</div>`;
        }

        function showAddMusicModal() {
            const modalId = 'add-music-modal';
            const html = `
                <div class="modal-content">
                    <div class="modal-title">导入新音乐</div>
                    <div class="modal-input-group"><label>音乐URL</label><input type="text" id="music-url-input" class="modal-input"></div>
                    <div class="modal-input-group"><label>歌名</label><input type="text" id="music-title-input" class="modal-input"></div>
                    <div class="modal-input-group"><label>作曲家</label><input type="text" id="music-artist-input" class="modal-input"></div>
                    <button class="modal-btn primary" id="save-music-btn" style="margin-top: 15px;">保存</button>
                </div>
            `;
            showModal(modalId, html);
            document.getElementById('save-music-btn').onclick = () => {
                const url = document.getElementById('music-url-input').value.trim();
                const title = document.getElementById('music-title-input').value.trim();
                const artist = document.getElementById('music-artist-input').value.trim();
                if (!url || !title || !artist) { alert('URL、歌名和作曲家不能为空'); return; }
                appData.music.library.push({ id: Date.now(), url, title, artist, lyrics: '' });
                saveData();
                renderMusicLists('all');
                closeModal(modalId);
            };
        }

        function toggleFavorite(songId, event) {
            event.stopPropagation();
            const index = appData.music.favorites.indexOf(songId);
            if (index > -1) appData.music.favorites.splice(index, 1);
            else appData.music.favorites.push(songId);
            saveData();
            renderMusicLists('all');
        }

        function playSong(songId) {
            const song = appData.music.library.find(s => s.id === songId);
            if (!song) return;
            appData.music.currentSongId = songId;
            audioPlayer.src = song.url;
            audioPlayer.play();
            appData.music.isPlaying = true;
            saveData();
            showPage('music-player-page', renderMusicPlayerPage);
            updateMiniPlayer();
        }

        function playNextSong() {
            const library = appData.music.library;
            if (library.length === 0) return;
            let currentIndex = library.findIndex(s => s.id === appData.music.currentSongId);
            let nextIndex;
            if (appData.music.playMode === 'single') nextIndex = currentIndex;
            else if (appData.music.playMode === 'random') nextIndex = Math.floor(Math.random() * library.length);
            else nextIndex = (currentIndex + 1) % library.length;
            playSong(library[nextIndex].id);
        }

        function playPreviousSong() {
            const library = appData.music.library;
            if (library.length === 0) return;
            let currentIndex = library.findIndex(s => s.id === appData.music.currentSongId);
            let prevIndex = (currentIndex - 1 + library.length) % library.length;
            playSong(library[prevIndex].id);
        }

        function togglePlayPause() {
            if (audioPlayer.paused) audioPlayer.play();
            else audioPlayer.pause();
            appData.music.isPlaying = !audioPlayer.paused;
            saveData();
            if (document.getElementById('music-player-page').classList.contains('active')) renderMusicPlayerPage(document.getElementById('music-player-page'));
            updateMiniPlayer();
        }

        function renderMusicPlayerPage(container) {
            const currentSong = appData.music.library.find(s => s.id === appData.music.currentSongId);
            if (!currentSong) {
                container.innerHTML = '<div class="wechat-header"><div class="header-left header-back-btn" onclick="goBack()"></div></div><div class="content-area" style="text-align:center; padding-top: 50%;">暂无播放歌曲</div>';
                return;
            }

            const playIcon = appData.music.isPlaying ? 'fa-pause-circle' : 'fa-play-circle';
            const playModeIcon = { 'sequence': 'fa-retweet', 'single': 'fa-redo-alt', 'random': 'fa-random' }[appData.music.playMode];

            container.innerHTML = `
                <div class="wechat-header" style="background: transparent; border: none; position: absolute; top: 0; left: 0; right: 0; z-index: 5;">
                    <div class="header-left header-back-btn" onclick="minimizeMusicPlayer()" style="color: white;"><i class="fas fa-chevron-down"></i></div>
                </div>
                <div class="content-area">
                    <div class="music-cover ${appData.music.isPlaying ? 'playing' : ''}" onclick="showPage('lyrics-page', renderLyricsPage)"></div>
                    <div class="music-info"><h3>${currentSong.title}</h3><p>${currentSong.artist}</p></div>
                    <div class="music-progress"><div class="music-progress-bar" id="music-progress-bar"></div></div>
                    <div class="music-controls">
                        <i class="fas ${playModeIcon}" onclick="togglePlayMode()"></i>
                        <i class="fas fa-backward" onclick="playPreviousSong()"></i>
                        <i class="fas ${playIcon}" onclick="togglePlayPause()"></i>
                        <i class="fas fa-forward" onclick="playNextSong()"></i>
                        <i class="fas fa-list-ul" onclick="showPage('music-library-page', renderMusicLibraryPage)"></i>
                    </div>
                </div>
            `;

            audioPlayer.ontimeupdate = () => {
                const progressBar = document.getElementById('music-progress-bar');
                if (progressBar && audioPlayer.duration) {
                    progressBar.style.width = `${(audioPlayer.currentTime / audioPlayer.duration) * 100}%`;
                }
                if (document.getElementById('lyrics-page').classList.contains('active')) updateLyricsScroll();
            };
        }

        function togglePlayMode() {
            const modes = ['sequence', 'single', 'random'];
            let currentIndex = modes.indexOf(appData.music.playMode);
            appData.music.playMode = modes[(currentIndex + 1) % modes.length];
            saveData();
            renderMusicPlayerPage(document.getElementById('music-player-page'));
        }

        function renderLyricsPage(container) {
            const currentSong = appData.music.library.find(s => s.id === appData.music.currentSongId);
            if (!currentSong || !currentSong.lyrics) {
                container.innerHTML = '<div class="wechat-header"><div class="header-left header-back-btn" onclick="goBack()"></div></div><div class="content-area" style="text-align:center; padding-top: 50%;">暂无歌词</div>';
                return;
            }

            const lyrics = parseLyrics(currentSong.lyrics);
            container.innerHTML = `
                <div class="wechat-header" style="background: transparent; border: none; position: absolute; top: 0; left: 0; right: 0; z-index: 5;">
                    <div class="header-left header-back-btn" onclick="goBack()" style="color: white;"><i class="fas fa-chevron-down"></i></div>
                </div>
                <div class="content-area" id="lyrics-content">
                    <div class="lyrics-container">${lyrics.map((line, index) => `<p class="lyrics-line" data-time="${line.time}" id="lyrics-line-${index}">${line.text}</p>`).join('')}</div>
                </div>
            `;
            updateLyricsScroll();
        }

        function parseLyrics(lyricsText) {
            return lyricsText.split('\n').map(line => {
                const match = line.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/);
                if (match) {
                    const time = parseInt(match[1]) * 60 + parseInt(match[2]) + parseInt(match[3].padEnd(3, '0')) / 1000;
                    return { time, text: match[4].trim() };
                }
                return null;
            }).filter(Boolean);
        }

        function updateLyricsScroll() {
            const lyricsContainer = document.querySelector('#lyrics-page .lyrics-container');
            if (!lyricsContainer) return;
            const currentSong = appData.music.library.find(s => s.id === appData.music.currentSongId);
            if (!currentSong || !currentSong.lyrics) return;
            const lyrics = parseLyrics(currentSong.lyrics);
            const currentTime = audioPlayer.currentTime;
            let activeIndex = -1;

            for (let i = 0; i < lyrics.length; i++) {
                if (currentTime >= lyrics[i].time) activeIndex = i;
                else break;
            }

            lyricsContainer.querySelectorAll('.lyrics-line').forEach((line, index) => {
                line.classList.toggle('active', index === activeIndex);
            });

            if (activeIndex > -1) {
                const activeLine = document.getElementById(`lyrics-line-${activeIndex}`);
                if (activeLine) {
                    const containerHeight = lyricsContainer.clientHeight;
                    constscrollOffset = activeLine.offsetTop - (containerHeight / 2) + (activeLine.offsetHeight / 2);
                    lyricsContainer.parentElement.scrollTop = scrollOffset;
                }
            }
        }

        function renderMusicSettingsPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">音乐设置</span>
                </div>
                <div class="content-area">
                    <div class="list-divider"></div>
                    <div class="list-item" onclick="showPage('player-beautify-page', renderPlayerBeautifyPage)">
                        <div class="details"><span class="name">播放器美化</span></div><i class="fas fa-chevron-right chevron"></i>
                    </div>
                </div>
            `;
        }

        function renderPlayerBeautifyPage(container) {
            container.innerHTML = `
                <div class="wechat-header">
                    <div class="header-left header-back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i><span>返回</span></div>
                    <span class="header-title">播放器美化</span>
                </div>
                <div class="content-area form-page">
                    <div class="form-group">
                        <label>更换播放器图片</label>
                        <img src="${appData.music.playerImage || 'https://img.js.design/assets/img/664e0d45692271d43c087968.jpg'}" class="avatar-upload-preview" id="player-image-preview" onclick="document.getElementById('player-image-input').click()">
                        <input type="file" id="player-image-input" class="file-input" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label>更换播放器背景图片</label>
                        <img src="${appData.music.playerBackground || 'https://img.js.design/assets/img/664e0d47e3a6821361b7829a.jpg'}" class="avatar-upload-preview" id="player-bg-preview" onclick="document.getElementById('player-bg-input').click()">
                        <input type="file" id="player-bg-input" class="file-input" accept="image/*">
                    </div>
                </div>
            `;
            document.getElementById('player-image-input').onchange = e => handleImageUpload(e.target.files[0], url => {
                appData.music.playerImage = url;
                saveData();
                applyBeautifySettings();
                document.getElementById('player-image-preview').src = url;
            });
            document.getElementById('player-bg-input').onchange = e => handleImageUpload(e.target.files[0], url => {
                appData.music.playerBackground = url;
                saveData();
                applyBeautifySettings();
                document.getElementById('player-bg-preview').src = url;
            });
        }

        function minimizeMusicPlayer() {
            goBack();
            updateMiniPlayer();
        }

        function updateMiniPlayer() {
            const miniPlayer = document.getElementById('mini-player');
            const miniPlayerCover = document.getElementById('mini-player-cover');
            const miniPlayerPlayPause = document.getElementById('mini-player-play-pause');
            const currentSong = appData.music.library.find(s => s.id === appData.music.currentSongId);

            if (currentSong) {
                miniPlayer.style.display = 'block';
                miniPlayerCover.style.backgroundImage = `url(${appData.music.playerImage || 'https://img.js.design/assets/img/664e0d45692271d43c087968.jpg'})`;
                miniPlayerCover.classList.toggle('playing', appData.music.isPlaying);
                miniPlayerPlayPause.className = `fas ${appData.music.isPlaying ? 'fa-pause' : 'fa-play'} play-pause-icon`;
            } else {
                miniPlayer.style.display = 'none';
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            await dataManager.init();
            await loadData();
            applyBeautifySettings();
            renderMainContent('chat-list');
            updateMiniPlayer();

            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.addEventListener('click', () => {
                    if (document.getElementById('moments-page').classList.contains('active')) goBack();
                    document.querySelector('.tab-item.active').classList.remove('active');
                    tab.classList.add('active');
                    renderMainContent(tab.dataset.page);
                    pageHistory = ['main-container'];
                });
            });

            const miniPlayer = document.getElementById('mini-player');
            miniPlayer.onclick = () => showPage('music-player-page', renderMusicPlayerPage);
            document.getElementById('mini-player-play-pause').onclick = (e) => { e.stopPropagation(); togglePlayPause(); };
            
            // Draggable Mini Player
            let isDragging = false;
            let offset = { x: 0, y: 0 };
            miniPlayer.addEventListener('mousedown', (e) => {
                isDragging = true;
                offset.x = e.clientX - miniPlayer.offsetLeft;
                offset.y = e.clientY - miniPlayer.offsetTop;
                miniPlayer.style.cursor = 'grabbing';
            });
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    miniPlayer.style.left = `${e.clientX - offset.x}px`;
                    miniPlayer.style.top = `${e.clientY - offset.y}px`;
                }
            });
            document.addEventListener('mouseup', () => {
                isDragging = false;
                miniPlayer.style.cursor = 'grab';
            });

            checkAndPostCharMoments();
        });
    </script>
</body>
</html>